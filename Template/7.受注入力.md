# 7.受注入力

# ワイヤーフレーム
![デザイン](https://cacoo.com/diagrams/U7E6XRzg0nfwjYh1-204B3.png)
[プレビュー](https://cacoo.com/diagrams/U7E6XRzg0nfwjYh1/204B3)

## 概要
[参照](https://github.com/LavaJavaSystemInc/tamada-coresystem-oldapp/blob/6e0f129fc3f15f0de8cd69b7a0216aacc9f26cab/Order/TAA0600/TAA0602D.aspx)

## エンドポイント
`/order/create`  ※パラメタで前画面から受注番号が引き継がれる

## 画面背景色
「ライトモード」及び「ダークモード」をボタン切替できるようにする

## 初期表示
### 新規作成
1. [共通処理１](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%91)を行う
2. 以下のボタンを無効(disable)にする  
   「受注書印刷」、「注文書印刷」、「納品書印刷」、「完了書印刷」、「変更履歴」

### 参照新規
1. [共通処理１](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%91)を行う
2. [共通処理２](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%92%E5%8F%82%E7%85%A7%E6%96%B0%E8%A6%8F%E5%8F%8A%E3%81%B3%E7%B7%A8%E9%9B%86%E3%83%A2%E3%83%BC%E3%83%89%E5%8F%97%E6%B3%A8%E8%A8%82%E6%AD%A3%E3%81%AE%E3%81%BF)を行う
3. 以下のボタンを無効(disable)にする  
   「受注書印刷」、「注文書印刷」、「納品書印刷」、「完了書印刷」、「変更履歴」  
4. [共通処理４](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%94)を行う

### 編集モード(受注訂正)
1. [共通処理１](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%91)を行う
2. [共通処理２](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%92%E5%8F%82%E7%85%A7%E6%96%B0%E8%A6%8F%E5%8F%8A%E3%81%B3%E7%B7%A8%E9%9B%86%E3%83%A2%E3%83%BC%E3%83%89%E5%8F%97%E6%B3%A8%E8%A8%82%E6%AD%A3%E3%81%AE%E3%81%BF)を行う
3. コントロール無効化  
   条件により画面上のコントロールの無効化を行う  
   1. 以下の条件のいずれかを満たす場合、下記「2. 対応」を行う
      - 受注.受注ＰＥ申請フラグ(peif_code1) = '1'(申請中)
      - 受注.削除フラグ(del_flag) = 1 and 受注.受注ＰＥ申請フラグ(peif_code1) = '5'(決裁)
      - 「完了日(complete_at)」が設定済
      -  [26. 仕訳計上設定](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#26-%E4%BB%95%E8%A8%B3%E8%A8%88%E4%B8%8A%E8%A8%AD%E5%AE%9A)で取得した仕訳連携フラグ(journal_entry_flag)が未設定('')以外の場合
   2. 対応  
      - [26. 仕訳計上設定](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#26-%E4%BB%95%E8%A8%B3%E8%A8%88%E4%B8%8A%E8%A8%AD%E5%AE%9A)で取得した仕訳連携フラグ(journal_entry_flag)が未設定('')以外の場合のみ以下のメッセージを表示する  
         「売上計上されています。受注情報の変更はできません。」
      - 下記のコントロール以外をdisable(プルダウンは選択不可、テキストの場合は入力不可(Readonly)、クリック不可)とする  
         - ボタン：「ライニング入力」、「受注書印刷」、「注文書印刷」、「納品書印刷」、「完了書印刷」、「変更履歴」、「原価明細照会」、「工事発注」
         - テキスト：現場郵便番号、現場住所
      - [工事発注入力画面の初期表示](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/14.%E5%B7%A5%E4%BA%8B%E7%99%BA%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%88%9D%E6%9C%9F%E8%A1%A8%E7%A4%BA)において、情報表示のみ可能とし「登録・更新」ボタンをdisable（クリック不可）とする（工事発注入力画面仕様「6. 「登録・更新」ボタン無効化」にも記載済）
4. [共通処理４](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%94)を行う

### 商談参照受注
1. [共通処理１](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%91)を行う
2. [共通処理３](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%93%E5%95%86%E8%AB%87%E5%8F%82%E7%85%A7%E5%8F%97%E6%B3%A8%E3%81%AE%E3%81%BF)を行う
3. 以下のボタンを無効(disable)にする  
   「受注書印刷」、「注文書印刷」、「納品書印刷」、「完了書印刷」、「変更履歴」
4. [共通処理４](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%94)を行う

## 1. 受注先オートコンプリート
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#1-%E5%8F%97%E6%B3%A8%E5%85%88%E3%82%AA%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%97%E3%83%AA%E3%83%BC%E3%83%88)

## 2. 施設名オートコンプリート
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/4.%E5%95%86%E8%AB%87%E5%85%A5%E5%8A%9B.md#10-%E6%96%BD%E8%A8%AD%E5%90%8D%E3%82%AA%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%97%E3%83%AA%E3%83%BC%E3%83%88)

## 3. 工種名／製品名オートコンプリート
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/4.%E5%95%86%E8%AB%87%E5%85%A5%E5%8A%9B.md#11-%E8%A3%BD%E5%93%81%E5%90%8D%E5%B7%A5%E7%A8%AE%E5%90%8D%E3%82%AA%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%97%E3%83%AA%E3%83%BC%E3%83%88)  
   ※工種名／製品名を選択された時点で、同一明細の「工種／製品コード」に対して該当する工種／製品コードを設定する

## 4. １行削除
1. 削除可否チェック  
削除が可能かどうかチェックする  
   - 削除対象明細の「発注金額」が0円でない場合、「発注済のため、削除できません。」のエラーメッセージを表示する
   - 削除対象明細の「検収金額」が0円でない場合、「検収済のため、削除できません。」のエラーメッセージを表示する
   - [10.製造指示](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/10.%E8%A3%BD%E9%80%A0%E6%8C%87%E7%A4%BA.md)の[getManufactureInstructions](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/10.%E8%A3%BD%E9%80%A0%E6%8C%87%E7%A4%BA.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて削除対象明細の受注番号及び受注明細番号の製造指示情報を取得する。製造指示情報にレコードが存在した場合、「製造指示済のため、削除できません。」のエラーメッセージを表示する
      #### リクエストパラメータ
      ```json
         getManufactureInstructions(
            request: {
               order_no: "...",
               detail_no: "..."
            }
         )
      ```
      - order_no: 前画面から引き継がれた受注番号
      - detail_no: 削除対象明細の「NO」
      - 各項目のマッピングは[製造指示シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
   - [45.工事発注](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/45.%E5%B7%A5%E4%BA%8B%E7%99%BA%E6%B3%A8.md)の[getConstructionOrders](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/45.%E5%B7%A5%E4%BA%8B%E7%99%BA%E6%B3%A8.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて削除対象明細の受注番号及び受注明細番号の工事発注情報を取得する。工事発注情報にレコードが存在した場合、「工事発注済のため、削除できません。」のエラーメッセージを表示する
      #### リクエストパラメータ
      ```json
         getConstructionOrders(
            request: {
               contract_no: "...",
               detail_no: "..."
            }
         )
      ```
      - contract_no: 前画面から引き継がれた受注番号
      - detail_no: 削除対象明細の「NO」
      - 各項目のマッピングは[工事発注シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
2. 削除実行確認  
「選択された明細行を削除します。よろしいですか？」の確認メッセージ（ＯＫ・キャンセル）を表示する  
ＯＫの場合は処理を継続し、キャンセルの場合は処理を中止する
3. 削除実行
   - 受注明細入力の該当行を１行削除（UIのみ）  
     ※削除された明細番号は欠番とする  
   - 実行予算合計の再計算

## 5. １行追加
受注明細入力に１行追加（UIのみ）  
※「No」は、初期表示時の明細における「No」の最大値 + 1を設定する

## 6. ライニング入力画面へ遷移
1. 遷移実行チェック
   - 受注区分が「一般工事」または「ライニング工事」の両工事以外の場合、「ライニング工事の受注ではありません。」のエラーメッセージを表示する
   - 施設名が入力されていない場合、「施設が設定されていません。ライニング入力に遷移できません。」のエラーメッセージを表示する
   - 施設名が「仮施設」（施設コードが"09999999"）の場合、「選択された受注の施設は仮施設です。ライニング入力に遷移できません。」のエラーメッセージを表示する
   - ライニング入力画面への遷移確認（受注区分が「一般工事」のみ）  
      「一般工事の受注ですが、ライニング入力に遷移しますか？」の確認メッセージ（ＯＫ・キャンセル）を表示する  
      - ＯＫの場合、事前チェックを行う
      - キャンセルの場合、処理を中止する
2. 事前チェック  
[各種チェック](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%90%84%E7%A8%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%A9%E3%82%A4%E3%83%8B%E3%83%B3%E3%82%B0%E5%85%A5%E5%8A%9B%E4%B8%80%E6%99%82%E4%BF%9D%E5%AD%98%E7%99%BB%E9%8C%B2%E7%94%B3%E8%AB%8B%E3%81%AE%E5%90%84%E3%83%9C%E3%82%BF%E3%83%B3%E6%8A%BC%E4%B8%8B%E6%99%82--%E5%87%A6%E7%90%86%E4%B8%AD%E6%AD%A2%E6%99%82%E3%81%AF%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E5%AF%BE%E8%B1%A1%E3%81%AE%E9%A0%85%E7%9B%AE%E3%81%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%82%AB%E3%82%B9%E3%82%92%E3%81%82%E3%81%A6%E7%B5%82%E4%BA%86%E3%81%99%E3%82%8B)を参照
3. 一時保存処理  
[受注入力情報一時保存](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B%E6%83%85%E5%A0%B1%E4%B8%80%E6%99%82%E4%BF%9D%E5%AD%98)を行う
4. ライニング入力画面へ遷移  
[21.受注入力（ライニング情報）](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/21.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B%EF%BC%88%E3%83%A9%E3%82%A4%E3%83%8B%E3%83%B3%E3%82%B0%E6%83%85%E5%A0%B1%EF%BC%89.md)へ遷移  
※受注入力（ライニング情報）画面へ受注番号を引き継ぐ

## 7. 変更履歴照会画面へ遷移  
[20.変更履歴照会](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/20.%E5%A4%89%E6%9B%B4%E5%B1%A5%E6%AD%B4%E7%85%A7%E4%BC%9A.md)へ遷移  
※変更履歴照会画面へ受注番号を引き継ぐ

## 8. 印刷出力確認モーダル  
[25.印刷開始確認モーダル](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/25.%E5%8D%B0%E5%88%B7%E9%96%8B%E5%A7%8B%E7%A2%BA%E8%AA%8D%E3%83%A2%E3%83%BC%E3%83%80%E3%83%AB.md)を表示
- 印刷開始確認がＯＫの場合、以下の処理を行う
   1. 受注書印刷の場合
      1. [65.受注書印刷API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/65.%E5%8F%97%E6%B3%A8%E6%9B%B8%E5%8D%B0%E5%88%B7.md)の[makeOrderExcel](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/65.%E5%8F%97%E6%B3%A8%E6%9B%B8%E5%8D%B0%E5%88%B7.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて受注書を取得
         #### リクエストパラメータ
         ```json
            makeOrderExcel(
               request: {
                  order_no: "..."
               }
            )
         ```
         - order_no: 前画面から引き継がれた受注番号
      2. 完了メッセージ表示
         以下の完了メッセージをダイアログ表示する  
         -----  ここから  -----  
         受注書印刷が完了しました。  
           ファイルパス：absolute_path(※1)  
           ファイル名　：file_name(※2)  
         -----  ここまで  -----  
         ※1：受注書印刷APIからの戻り値のアップロード先のフルパス(absolute_path)  
         ※2：受注書印刷APIからの戻り値のアップロードファイル名(file_name)  
   2. 注文書印刷の場合
      1. [66.注文書印刷API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/66.%E6%B3%A8%E6%96%87%E6%9B%B8%E5%8D%B0%E5%88%B7.md)の[makeOrderFormExcel](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/66.%E6%B3%A8%E6%96%87%E6%9B%B8%E5%8D%B0%E5%88%B7.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて注文書を取得
         #### リクエストパラメータ
         ```json
            makeOrderFormExcel(
               request: {
                  order_no: "..."
               }
            )
         ```
         - order_no: 前画面から引き継がれた受注番号
      2. 完了メッセージ表示
         以下の完了メッセージをダイアログ表示する  
         -----  ここから  -----  
         注文書印刷が完了しました。  
           ファイルパス：absolute_path(※1)  
           ファイル名　：file_name(※2)  
         -----  ここまで  -----  
         ※1：注文書印刷APIからの戻り値のアップロード先のフルパス(absolute_path)  
         ※2：注文書印刷APIからの戻り値のアップロードファイル名(file_name)  
   3. 完了書印刷
      1. [67.完了書印刷API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/67.%E5%AE%8C%E4%BA%86%E6%9B%B8%E5%8D%B0%E5%88%B7.md)の[makeOrderCompleteExcel](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/67.%E5%AE%8C%E4%BA%86%E6%9B%B8%E5%8D%B0%E5%88%B7.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて完了書を取得
         #### リクエストパラメータ
         ```json
            makeOrderCompleteExcel(
               request: {
                  order_no: "..."
               }
            )
         ```
         - order_no: 前画面から引き継がれた受注番号
      2. 完了メッセージ表示
         以下の完了メッセージをダイアログ表示する  
         -----  ここから  -----  
         完了書印刷が完了しました。  
           ファイルパス：absolute_path(※1)  
           ファイル名　：file_name(※2)  
         -----  ここまで  -----  
         ※1：完了書印刷APIからの戻り値のアップロード先のフルパス(absolute_path)  
         ※2：完了書印刷APIからの戻り値のアップロードファイル名(file_name)  
- キャンセルの場合、印刷開始確認モーダル画面を閉じる

## 9. 納品書印刷画面へ遷移
1. [23.納品書印刷](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/23.%E7%B4%8D%E5%93%81%E6%9B%B8%E5%8D%B0%E5%88%B7.md)へ遷移  
※納品書印刷画面へ受注番号を引き継ぐ

## 10. 工事発注入力画面へ遷移
[14.工事発注入力](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/14.%E5%B7%A5%E4%BA%8B%E7%99%BA%E6%B3%A8%E5%85%A5%E5%8A%9B.md)へ遷移  
※工事発注入力画面へ受注番号及び明細番号を引き継ぐ（明細番号はボタン押下行のNo）

## 11. 原価明細照会画面へ遷移
[18.原価明細照会](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/18.%E5%8E%9F%E4%BE%A1%E6%98%8E%E7%B4%B0%E7%85%A7%E4%BC%9A.md)へ遷移  
※原価明細照会画面へ受注番号及び明細番号を引き継ぐ（明細番号は全明細のNoをarray形式にて引き継ぐ）

## 12. コードマスタプルダウン
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#2-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)
- 補記
   - 受注形態: JUKE
   - 給油所等の別: KYUU
   - マーク: MARK
   - 金種: KNSY
   - 支払月: SIHA

## 13. 管轄支店プルダウン
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#3-%E6%94%AF%E5%BA%97%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)

## 14. 担当部署プルダウン
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#4-%E9%83%A8%E7%BD%B2%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)

## 15. 担当者プルダウン
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#5-%E6%8B%85%E5%BD%93%E8%80%85%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)

## 16. 注文書有無プルダウン
以下の値にてプルダウンを作成する
- Value: Text
   - "": ""
   -  0: 無
   -  1: 有

## 17. 一時保存処理  <!-- TODO:GraphQL側でTransaction処理実装を検討 -->
1. 事前チェック  
[各種チェック](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%90%84%E7%A8%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%A9%E3%82%A4%E3%83%8B%E3%83%B3%E3%82%B0%E5%85%A5%E5%8A%9B%E4%B8%80%E6%99%82%E4%BF%9D%E5%AD%98%E7%99%BB%E9%8C%B2%E7%94%B3%E8%AB%8B%E3%81%AE%E5%90%84%E3%83%9C%E3%82%BF%E3%83%B3%E6%8A%BC%E4%B8%8B%E6%99%82--%E5%87%A6%E7%90%86%E4%B8%AD%E6%AD%A2%E6%99%82%E3%81%AF%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E5%AF%BE%E8%B1%A1%E3%81%AE%E9%A0%85%E7%9B%AE%E3%81%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%82%AB%E3%82%B9%E3%82%92%E3%81%82%E3%81%A6%E7%B5%82%E4%BA%86%E3%81%99%E3%82%8B)を参照
2. 一時保存処理  
[受注入力情報一時保存](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B%E6%83%85%E5%A0%B1%E4%B8%80%E6%99%82%E4%BF%9D%E5%AD%98)を行う
3. 完了メッセージ表示
   - 「一時保存が完了しました。　受注番号：xxxxxxxxxxx」のメッセージを表示する。　※"xxxxxxxxxxx"は、登録(更新)した受注番号を設定
   - 完了メッセージが閉じられた時点で受注入力画面を閉じ、前画面（商談一覧画面(参照受注時)または受注一覧画面）へ戻る  
     その際、受注入力画面への遷移前の検索パラメタにてリロードする

## 18. 登録申請処理  <!-- TODO:GraphQL側でTransaction処理実装を検討 -->
1. 事前チェック  
[各種チェック](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%90%84%E7%A8%AE%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%83%A9%E3%82%A4%E3%83%8B%E3%83%B3%E3%82%B0%E5%85%A5%E5%8A%9B%E4%B8%80%E6%99%82%E4%BF%9D%E5%AD%98%E7%99%BB%E9%8C%B2%E7%94%B3%E8%AB%8B%E3%81%AE%E5%90%84%E3%83%9C%E3%82%BF%E3%83%B3%E6%8A%BC%E4%B8%8B%E6%99%82--%E5%87%A6%E7%90%86%E4%B8%AD%E6%AD%A2%E6%99%82%E3%81%AF%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E5%AF%BE%E8%B1%A1%E3%81%AE%E9%A0%85%E7%9B%AE%E3%81%AB%E3%83%95%E3%82%A9%E3%83%BC%E3%82%AB%E3%82%B9%E3%82%92%E3%81%82%E3%81%A6%E7%B5%82%E4%BA%86%E3%81%99%E3%82%8B)を行う
2. 一時保存処理  
[受注入力情報一時保存](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B%E6%83%85%E5%A0%B1%E4%B8%80%E6%99%82%E4%BF%9D%E5%AD%98)を行う
3. 登録申請  
[SQS情報(申請時)](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/common/SQS%E6%83%85%E5%A0%B1.md#%E7%94%B3%E8%AB%8B%E6%99%82)を参照
4. 完了メッセージ表示
   - 「登録申請が完了しました。　受注番号：xxxxxxxxxxx」のメッセージを表示する。　※"xxxxxxxxxxx"は、登録(更新)した受注番号を設定
   - 完了メッセージが閉じられた時点で受注入力画面を閉じ、前画面（商談一覧画面(参照受注時)または受注一覧画面）へ戻る  
     その際、受注入力画面への遷移前の検索パラメタにてリロードする

## 19. 予算自動計算
- トリガー  
   受注金額入力（変更）時、受注明細の実行予算入力（変更）時、受注明細の行削除時  
- 計算方法
   - 実行予算合計：受注明細の実行予算を合算した値を設定
   - 粗利額（金額）：「受注金額 - 実行予算合計」の計算結果を設定
   - 粗利額（割合）：「（粗利額（金額）/ 受注金額 ）* 100」の計算結果を小数点第三位にて四捨五入して小数点第ニ位までを設定  
     ※受注金額が0円の場合は、粗利額（割合）は算出しない

## 20. 規定率取得処理
- トリガー  
   受注金額入力（変更）時、受注明細の実行予算入力（変更）時  
- 取得方法
   1. 受注金額かつ受注区分が入力されている場合のみ取得処理（2.以降）を行う
   2. コードマスタから規定データを取得
      -  [こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#2-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)
      - 補記
         - 規定: KITI
   3. 取得した規定データの内、下記条件全てに該当するデータを取得
      - 区分１(kind1) =  選択されている受注区分に該当する「区分５(kind5)」の値  
          ※12.コードマスタプルダウン（受注区分: JUCY）生成時に取得した「区分５(kind5)」を使用  
      - 文字１(str1) =  選択されている担当部署に該当する部署コード  
          ※14.担当部署プルダウン生成時に取得した部署コードを使用  
      - 数値１(num1) <= 入力された受注金額
      - 数値２(num2) >= 入力された受注金額
   4. 3.の条件に該当するデータがあった場合、該当データの「数値３(num3)」を規定率として設定
      - 3.の条件に該当するデータがなかった場合、下記条件全てに該当するデータを取得
         - 区分１(kind1) =  選択されている受注区分に該当する「区分５(kind5)」の値  
             ※12.コードマスタプルダウン（受注区分: JUCY）生成時に取得した「区分５(kind5)」を使用  
         - 文字１(str1) =  '9999'
         - 数値１(num1) <= 入力された受注金額
         - 数値２(num2) >= 入力された受注金額
   5. 4.の条件に該当するデータがあった場合、該当データの「数値３(num3)」を規定率として設定し、該当するデータがなかった場合、規定率を「0」に設定

## 21. 請求予定額計算
計算方法  
   - 新規作成時は画面入力された「請求金額１」、「請求金額２」、「請求金額３」を合計  
   - 参照新規及び受注訂正時は受注情報の「請求額１回目」、「請求額２回目」「請求額３回目」の合計  

## 22. 請求済金額計算
計算方法  
   - 請求APIで取得した請求一覧のうち、削除フラグ(delete_flag) <> '1'のデータの「請求金額」を合計  
      -  [24.請求API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/24.%E8%AB%8B%E6%B1%82.md)の[getBilling](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/24.%E8%AB%8B%E6%B1%82.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて請求一覧（請求金額(billing_amount)、削除フラグ(delete_flag)）を取得
      #### リクエストパラメータ
      ```json
         getBillings(
            request: {
               order_no: "..."
            }
         )
      ```
      - order_no: 前画面から引き継がれた受注番号
      - 各項目のマッピングは[請求シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)

## 23. 支払済金額計算
計算方法  
   - 受注明細の支払済金額(paid_amount)を合計  

## 24. 実績粗利額計算
計算方法  
   - 粗利額（金額）：「請求済金額 - 支払済金額」の計算結果を設定
   - 粗利額（割合）：「（粗利額（金額）/ 請求済金額  ）* 100」の計算結果小数点第三位にて四捨五入して小数点第ニ位までを設定  
     ※請求済金額が0円の場合は、粗利額（割合）は算出しない

## 25. 明細受注金額合計
計算方法  
   - 受注明細の「金額(amount)」の合計

## 26. 仕訳計上設定
   - 売上APIで仕訳連携フラグ(journal_entry_flag)を取得
      - [37.売上API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/37.%E5%A3%B2%E4%B8%8A.md)の[getSales](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/37.%E5%A3%B2%E4%B8%8A.md#getsales%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF)クエリを用いて仕訳連携フラグを取得
         #### リクエストパラメータ
         ```json
            getSales(
               request: {
                  order_no: "..."
               }
            )
         ```
         - order_no: 前画面から引き継がれた受注番号
         - 各項目のマッピングは[売上シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
   - 仕訳連携フラグが取得できた場合  
      - 1(仕訳済)または2(工事完成済)の場合、"計上済"を設定
      - 上記以外、"未計上"を設定
   - 仕訳連携フラグが取得できなかった場合
      - "未計上"を設定
## 27. 受注明細金額計算
計算方法  
   - 数量：画面入力値（新規時）または、受注明細.数量(num)
   - 単価：画面入力値（新規時）または、受注明細.単価(unit)
   - 金額 = 数量 * 単価    ※数量または単価が未設定('')は、未設定('')

## 28. 予算残額計算
計算方法  
   - 実行予算：画面入力値（新規時）または、受注明細.実行予算(budget)
   - 発注金額：画面明細上の発注金額
   - 検収金額：以下で取得した情報一覧において受注番号、受注明細番号が一致するデータの検収金額(inspection_amount)の合計  
      [46.工事検収API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/46.%E5%B7%A5%E4%BA%8B%E6%A4%9C%E5%8F%8E.md)の[getConstructionInspections](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/46.%E5%B7%A5%E4%BA%8B%E6%A4%9C%E5%8F%8E.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
      #### リクエストパラメータ
      ```json
         getConstructionInspections(
            request: {
               order_no: "...",
               contract_no: "..."
            }
         )
      ```
      - order_no: ' '
      - contract_no: 受注.受注番号(no)
      - 各項目のマッピングは[工事検収シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
   - 予算残額：実行予算 - 発注金額 - 検収金額

## 29. 検収残額計算
計算方法  
   - 検収金額：画面明細上の検収金額
   - 検収残額：画面明細上の発注金額 - 検収金額

## 30. 工事担当者オートコンプリート
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/6.%E5%8F%97%E6%B3%A8%E4%B8%80%E8%A6%A7.md#23-%E5%B7%A5%E4%BA%8B%E6%8B%85%E5%BD%93%E8%80%85%E3%82%AA%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%97%E3%83%AA%E3%83%BC%E3%83%88)

## 31. 発注先（代表）オートコンプリート
[こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#1-%E5%8F%97%E6%B3%A8%E5%85%88%E3%82%AA%E3%83%BC%E3%83%88%E3%82%B3%E3%83%B3%E3%83%97%E3%83%AA%E3%83%BC%E3%83%88)

## 32. ステータス表示  
   編集モード(受注訂正)の場合のみ、以下を行う
   - [共通処理２（参照新規及び編集モード(受注訂正)のみ）](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%92%E5%8F%82%E7%85%A7%E6%96%B0%E8%A6%8F%E5%8F%8A%E3%81%B3%E7%B7%A8%E9%9B%86%E3%83%A2%E3%83%BC%E3%83%89%E5%8F%97%E6%B3%A8%E8%A8%82%E6%AD%A3%E3%81%AE%E3%81%BF)における「1. 受注情報の対象データを取得」で取得した受注.受注ＰＥ申請フラグ(peif_code)に紐づくコード.略称(ryaku_name)を取得
   - 「Badge」：上記で取得した略称を[tailwindのBadge(Flat)](https://tailwindcss.com/plus/ui-blocks/application-ui/elements/badges)を使用して赤色にて表示する

### 共通処理１
1. 管轄支店プルダウンの作成  
[13. 管轄支店プルダウン](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#13-%E7%AE%A1%E8%BD%84%E6%94%AF%E5%BA%97%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)を参照

2. 受注区分プルダウンの作成  
[12. コードマスタプルダウン](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#12-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)を参照

3. 受注形態プルダウンの作成  
[12. コードマスタプルダウン](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#12-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)を参照

4. マークプルダウンの作成  
[12. コードマスタプルダウン](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#12-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)を参照  
※マークについては、コード.表示順(order_no)の昇順にてプルダウンを作成する

5. 注文書有無プルダウンの作成  
[16. 注文書有無プルダウン](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#16-%E6%B3%A8%E6%96%87%E6%9B%B8%E6%9C%89%E7%84%A1%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)を参照

6. 必須項目の背景色変更  
以下の必須項目の入力域について、背景色を淡い黄色（#FFFFCC）に変更する  
  受注日、受注区分、受注詳細区分、管轄支店、担当部署、担当者、マーク、受注先名、施設名

### 共通処理２（参照新規及び編集モード(受注訂正)のみ）
1. 受注情報の対象データを取得  
[4.受注API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/4.%E5%8F%97%E6%B3%A8.md)の[getOrderByNo](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/4.%E5%8F%97%E6%B3%A8.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象データを取得
   #### リクエストパラメータ
   ```json
      getOrderByNo(
         request: {
            no: "..."
         }
      )
   ```
   - no: 前画面から引き継がれた受注番号
   - 各項目のマッピングは[受注シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)

2. 受注APIの実行結果を確認  
   - 正常終了した場合、受注明細情報の対象データを取得  
      - [5.受注明細API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md)の[getOrderDetailsByOrderNo](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象データを取得。複数ページ分のデータがある場合は、APIのコールをpageをインクリメントしながら「総ページ数(totalPages)」分、繰り返し行い「総件数(totalElements)」分取得する
         #### リクエストパラメータ
         ```json
            getOrderDetailsByOrderNo(
               request: {
                  order_no: "...",
                  page: "..." ,
                  size: 100
               }
            )
         ```
         - order_no: 受注一覧にて受注明細が選択された行に該当する受注番号
         - page : 0～総ページ数(totalPages)を指定
         - size: 100固定
         - 各項目のマッピングは[受注明細シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 受注明細APIの実行結果を確認
         - 正常終了した場合
            - 受注API及び受注明細APIで取得したデータをもとに、以下を行う
               - 「受注番号」: 受注.受注番号(no)を設定
               - 「受注日」: 受注.受注日(date)をYYYY/MM/DD形式にて設定
               - 「受注区分」: 受注.受注区分(jucy_code)の値を選択
               -  受注詳細区分プルダウンの作成
                  - コードAPIで取得した情報一覧のうち、「区分１(kind1)」が上記で選択した「受注区分」と一致する情報のみで「表示順(order_no)」の順にて「コード(code)」及び「略称(ryaku_name)」をもとにプルダウンを生成し、受注.区分詳細(sysi_code)の値を選択  
                    一致する情報がなかった場合、未設定('')の選択肢のみのプルダウンを生成
                     - [38.コードAPI](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md)の[getCodes](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
                     #### リクエストパラメータ
                     ```json
                        getCodes(
                           request: {
                              kind_code: "...",
                              code: "..."
                           }
                       )
                     ```
                     - kind_code: SYSI
                     - code: 受注.区分詳細(sysi_code)
                     - 各項目のマッピングは[コードシートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
               - 「商談番号」：受注.商談番号(nego_no)を設定
               - 「請求先」：取引先APIで取得した取引先.取引先名(name)
                  - [39.取引先API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/39.%E5%8F%96%E5%BC%95%E5%85%88.md)の[getBusinessPartners](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/39.%E5%8F%96%E5%BC%95%E5%85%88.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象データを取得
                  #### リクエストパラメータ
                  ```json
                     getBusinessPartners(
                        request: {
                           code: "..."
                        }
                     )
                  ```
                  - code: 受注.請求先コード(invoice_dest_code)
                  - 各項目のマッピングは[取引先シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
               - 「受注形態」：受注.受注形態(juke_code)を選択
               - 「管轄支店」：受注.管轄支店(branch_code)を選択
               -  担当部署プルダウンの作成
                  - 部署APIで取得した情報一覧の「部署コード(code)」及び「部署名(name)」をもとにプルダウンを生成し、受注.担当部署(department_code)の値を選択  
                    一致する情報がなかった場合、未設定('')の選択肢のみのプルダウンを生成  
                     - [42.部署API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/42.%E9%83%A8%E7%BD%B2.md)の[getDepartments](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/42.%E9%83%A8%E7%BD%B2.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
                     #### リクエストパラメータ
                     ```json
                        getDepartments(
                           request: {
                              branch_code: "...",
                              sort_column1: "...",
                              order1: "..."
                           }
                        )
                     ```
                     - branch_code: 受注.管轄支店(branch_code)
                     - sort_column1: 「管轄支店」が未設定('')場合："表示順"、未設定('')以外の場合："部署コード"
                     - order1: "asc"
                     - 各項目のマッピングは[部署シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
               - 担当者プルダウンの作成
                  - 社員APIで取得した情報一覧のうち、退職区分(retire_kind)が'1'以外のデータの後に退職区分(retire_kind)が'1'のデータを追加した並びで「社員コード(code)」及び「社員名(name)」をもとにプルダウンを生成し、受注.担当者(owner_code)を選択  
                    一致する情報がなかった場合、未設定('')の選択肢のみのプルダウンを生成。但し、「退職区分(retire_kind)」が'1'の社員については、社員名の先頭に'★'を追記  
                     - [41.社員API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/41.%E7%A4%BE%E5%93%A1.md)の[getEmployees](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/41.%E7%A4%BE%E5%93%A1.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
                     #### リクエストパラメータ
                     ```json
                        getEmployees(
                           request: {
                              department_code: "...",
                              sort_column1: "...",
                              order1: "..."
                           }
                        )
                     ```
                     - department_code: 受注.担当部署(department_code)
                     - sort_column1: "社員コード"
                     - order1: "asc"
                     - 各項目のマッピングは[社員シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
               - 「マーク」: 受注.マーク(mark_code)を選択
               - 「搬入時間」：受注.搬入時間(carry_time)を設定
               - 「検査時間」：受注.検査時間(inspection_time)を設定
               - 「受注先（名前）」:受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先名(name)を設定。受注.受注先コード(order_dest_code)が未設定('')の場合、受注.受注先名(order_dest_name)を設定
               - 「受注先（コード）」：受注.受注先コード(order_dest_code)を設定
               - 「受注先住所（郵便番号）」：受注.受注先郵便番号(order_dest_postcode)を設定
               - 「受注先住所（住所）」：受注.受注先住所(order_dest_address)を設定
               - 「工事担当者」：受注.工事担当者(worker_code)を選択
               - 「工事引渡日」：受注.工事引渡日(work_delivery_at)をYYYY/MM/DD形式にて設定
               - 「受注先担当部署」：受注.受注先担当部署(order_dest_department)を設定
               - 「受注先担当者」：受注.受注先担当者(order_dest_owner)を設定
               - 「受注先電話番号」：受注.受注先電話番号(order_dest_tel)を設定
               - 「受注先FAX番号」：受注.受注先ＦＡＸ番号(order_dest_fax)を設定
               - 「工期（開始）」：受注.工期_開始日(work_start_at)をYYYY/MM/DD形式にて設定
               - 「工期（終了）」：受注.工期_終了日(work_end_at)をYYYY/MM/DD形式にて設定
               - 「タンク引渡日」：受注.タンク引渡日(tank_delivery_at)をYYYY/MM/DD形式にて設定
               - 「決定」：受注.引渡決定(is_delivery)が'1'の場合、チェックボックスをTrueに設定
               - 「受注区分」が'41'(水：ＦＳＦ防火水槽)または'45'(水：ＦＳＶ防火水槽)の場合、以下を行う
                  - 「タンク引渡日２」：受注.タンク引渡日２(tank_delivery2_at)をYYYY/MM/DD形式にて設定
                  - 「決定２」：受注.引渡決定２(is_delivery2)が'1'の場合、チェックボックスをTrueに設定
                  - 「タンク引渡日３」：受注.タンク引渡日３(tank_delivery3_at)をYYYY/MM/DD形式にて設定
                  - 「決定３」：受注.引渡決定３(is_delivery3)が'1'の場合、チェックボックスをTrueに設定
               - 「受注区分」が'41'(水：ＦＳＦ防火水槽)以外かつ'45'(水：ＦＳＶ防火水槽)以外の場合、以下を行う
                  - 「タンク引渡日２」：''を設定し、入力域を読み取り専用に設定
                  - 「決定２」：チェックボックスをFalseに設定
                  - 「タンク引渡日３」：'を設定、入力域を読み取り専用に設定
                  - 「決定３」：チェックボックスをFalseに設定
               - 「完了日」：受注.完了日(complete_at)をYYYY/MM/DD形式にて設定
               - 「受注金額」：受注.受注金額(order_amount)を3桁毎の','区切り表記（例：1,500）で設定
               - 「実行予算合計」：受注明細APIで取得した受注明細情報一覧の「実行予算(budget)」の合計値を3桁毎の','区切り表記（例：1,500）で設定
               - 「粗利額（金額）」：「受注金額 - 実行予算合計」の計算結果を3桁毎の','区切り表記（例：1,500）で設定
               - 「粗利額（割合）」：「（粗利額（金額）/ 受注金額 ）* 100」の計算結果小数点第三位にて四捨五入して小数点第ニ位までを設定  
                    ※受注金額が0円の場合は、粗利額（割合）は算出せず、'0.00'を設定  
               - 「見積番号」：受注.見積番号(estimate_no)を設定
               - 「所轄行政」：受注.所轄行政(site_gov)を設定
               - 「現場名」：受注.現場名(site_name)を設定
               - 「現場電話番号」：受注.現場電話番号(site_tel)を設定
               - 「現場FAX番号」：受注.現場ＦＡＸ番号(site_fax)を設定
               - 「現場地域」：受注.現場地域(site_area)を設定
               - 「給油所等の別」：受注.給油所等の別(kyuu_code)を選択
               - 「現場住所（郵便番号）」：受注.現場郵便番号(site_postcode)を設定
               - 「現場住所（住所）」：受注.現場住所(site_address)を設定
               - 「施設名（名前）」：受注.施設コード(code)にリレーションされている施設.施設名(name)を設定。受注.施設コード(code)が未設定('')の場合、受注.施設名(name)を設定
               - 「施設名（コード）」：受注.施設コード(code)を設定
               - 「請求予定額」：「受注.請求額１回目(invoice1_amount) + 受注.請求額２回目(invoice2_amount) + 受注.請求額３回目(invoice3_amount)」の計算結果を3桁毎の','区切り表記（例：1,500）で設定
               - 「請求金額１」：受注.請求額１回目(invoice1_amount)を3桁毎の','区切り表記（例：1,500）で設定
               - 「請求日１」：受注.請求日１回目(invoice1_at)をYYYY/MM/DD形式にて設定
               - 「請求金額２」：受注.請求額２回目(invoice2_amount)を3桁毎の','区切り表記（例：1,500）で設定
               - 「請求日２」：受注.請求日２回目(invoice2_at)をYYYY/MM/DD形式にて設定
               - 「請求金額３」：受注.請求額３回目(invoice3_amount)を3桁毎の','区切り表記（例：1,500）で設定
               - 「請求日３」：受注.請求日３回目(invoice3_at)をYYYY/MM/DD形式にて設定
               - 受注先支払条件（通常）
                  - 「締日」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.締日(close_day)を設定  
                  - 「金種」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.支払金種１(knsy_code1)を設定
                  - 「サイト」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.サイト１(site1)を設定
                  - 「支払月」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.支払月(pay_month)を設定
                  - 「支払日」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.支払日(pay_day)を設定
               - 「注文書有無」：受注.注文書有無(is_form)を選択
               - 「仕訳計上」：[26. 仕訳計上設定](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#26-%E4%BB%95%E8%A8%B3%E8%A8%88%E4%B8%8A%E8%A8%AD%E5%AE%9A)を参照
               - 「特記事項」：受注.特記事項(special_remark)を設定
               - 「請求済金額」：[22. 請求済金額計算](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#22-%E8%AB%8B%E6%B1%82%E6%B8%88%E9%87%91%E9%A1%8D%E8%A8%88%E7%AE%97)を参照  
                  計算結果を3桁毎の','区切り表記（例：1,500）で設定
               - 「支払済金額」：[23. 支払済金額計算](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#23-%E6%94%AF%E6%89%95%E6%B8%88%E9%87%91%E9%A1%8D%E8%A8%88%E7%AE%97)を参照  
                  計算結果を3桁毎の','区切り表記（例：1,500）で設定
               - 「粗利額（金額）」：[24. 実績粗利額計算](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#24-%E5%AE%9F%E7%B8%BE%E7%B2%97%E5%88%A9%E9%A1%8D%E8%A8%88%E7%AE%97)を参照  
                  計算結果を3桁毎の','区切り表記（例：1,500）で設定
               - 「粗利額（割合）」：[24. 実績粗利額計算](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#24-%E5%AE%9F%E7%B8%BE%E7%B2%97%E5%88%A9%E9%A1%8D%E8%A8%88%E7%AE%97)を参照
               - 受注明細入力
                  - 「工種名／製品名」：商品APIで取得した商品.商品名(name)
                     - [53.商品API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/53.%E5%95%86%E5%93%81.md)の[getProductByCode](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/53.%E5%95%86%E5%93%81.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象データを取得
                     #### リクエストパラメータ
                     ```json
                        getProductByCode(
                           request: {
                              code: "..."
                           }
                        )
                     ```
                     - code: 受注明細.製品コード(product_code)
                     - 各項目のマッピングは[商品シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
                  - 「工種／製品コード」：受注明細.製品コード(product_code)を設定
                  - 「数量」：受注明細.数量(num)を3桁毎の','区切り表記（例：1,500）で設定
                  - 「単価」：受注明細.単価(unit)を3桁毎の','区切り表記（例：1,500）で設定
                  - 「金額」：受注明細.金額(amount)を3桁毎の','区切り表記（例：1,500）で設定
                  - 「実行予算」：受注明細.実行予算(budget)を3桁毎の','区切り表記（例：1,500）で設定
                  - 「発注金額」：参照新規の場合は0、編集モード(受注訂正)の場合は受注明細.発注済金額(ordered_amount)を3桁毎の','区切り表記（例：1,500）で設定
                  - 「予算残額」：[28. 予算残額計算](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#28-%E4%BA%88%E7%AE%97%E6%AE%8B%E9%A1%8D%E8%A8%88%E7%AE%97)を参照  
                     計算結果を3桁毎の','区切り表記（例：1,500）で設定
                  - 「検収金額」：参照新規の場合は0、編集モード(受注訂正)の場合は受注明細.支払済金額(paid_amount)を3桁毎の','区切り表記（例：1,500）で設定
                  - 「検収残額」：[29. 検収残額計算](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#29-%E6%A4%9C%E5%8F%8E%E6%AE%8B%E9%A1%8D%E8%A8%88%E7%AE%97)を参照  
                     計算結果を3桁毎の','区切り表記（例：1,500）で設定
                  - 「発注先（代表）」：受注明細.代表発注先名(supplier_name)に括弧で受注明細.代表発注先コード(supplier_code)を追記した値を設定　　例）ＡＡＡ株式会社（12345678）
               - 参照新規の場合、下記の入力域及び選択域を初期化する  
                 「受注番号」、「受注日」、「完了日」、「商談番号」、「請求金額１」、「請求日１」、「請求金額２」、「請求日２」、「請求金額３」、「請求日３」、「請求予定額」、「搬入時間」、「検査時間」、「タンク引渡日」、「引渡決定」、「タンク引渡日２」、「引渡決定２」、「タンク引渡日３」、「引渡決定３」、「工事引渡日」、「工期(開始日)」、「工期(終了日)」、「請求済金額」、「支払済金額」、「粗利額（金額）」、「粗利額（割合）」
         - 異常終了した場合
            - システムのエラーメッセージを表示後、エラー終了する  
   - 異常終了した場合  
      - 「該当データなし」の場合
         - 「受注データを取得できませんでした。」のエラーメッセージを表示後、エラー終了する
      - 「該当データなし以外」の場合
         - システムのエラーメッセージを表示後、エラー終了する

### 共通処理３（商談参照受注のみ）
1. 対象レコードのデータを取得  
[1.商談API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/1.%E5%95%86%E8%AB%87.md)の[getNegotiationByNo](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/1.%E5%95%86%E8%AB%87.md#getnegotiationbyno%E3%83%91%E3%83%A9%E3%83%A1%E3%83%BC%E3%82%BF)クエリを用いて対象データを取得
#### リクエストパラメータ
```json
   getNegotiationByNo(
      request: {
         no: "..."
      }
   )
```
- no: 商談一覧画面から引き継がれた商談番号
- 各項目のマッピングは[商談シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)

2. 商談APIの実行結果を確認  
正常終了した場合  
   [2.商談明細API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/2.%E5%95%86%E8%AB%87%E6%98%8E%E7%B4%B0.md)の[getNegotiationDetailsByNegoNo](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/2.%E5%95%86%E8%AB%87%E6%98%8E%E7%B4%B0.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象データを取得。複数ページ分のデータがある場合は、APIのコールをpageをインクリメントしながら「総ページ数(totalPages)」分、繰り返し行い「総件数(totalElements)」分取得する
   #### リクエストパラメータ
   ```json
      getNegotiationDetailsByNegoNo(
         request: {
            nego_no: "...",
            page: "...",
            size: 100
         }
      )
   ```
   - nego_no: 商談一覧画面から引き継がれた商談番号
   - page : 0～総ページ数(totalPages)を指定
   - size: 100固定
   - 各項目のマッピングは[商談明細シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
- 商談明細APIの実行結果を確認
   - 正常終了した場合
      - 商談API及び商談明細APIで取得したデータをもとに、以下を行う
         - 「受注区分」: 商談.受注区分(jucy_code)の値を選択
         -  受注詳細区分プルダウンの作成  
            [38.コードAPI](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md)の[getCodes](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
            #### リクエストパラメータ
            ```json
               getCodes(
                  request: {
                     kind_code: "...",
                     code: "..."
                  }
               )
            ```
            - kind_code: SYSI
            - code: 受注.区分詳細(sysi_code)
         - 取得した情報一覧のうち、「区分１(kind1)」が上記で選択した「受注区分」と一致する情報のみで「表示順(order_no)」の順にて「コード(code)」及び「略称(ryaku_name)」をもとにプルダウンを生成し、受注.区分詳細(sysi_code)の値を選択  
           一致する情報がなかった場合、未設定('')の選択肢のみのプルダウンを生成  
         - 「商談番号」: 商談.商談番号(no)を設定
         - 「請求先」：取引先APIで取得した取引先.取引先名(name)  
            [39.取引先API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/39.%E5%8F%96%E5%BC%95%E5%85%88.md)の[getBusinessPartners](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/39.%E5%8F%96%E5%BC%95%E5%85%88.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象データを取得
            #### リクエストパラメータ
            ```json
               getBusinessPartners(
                  request: {
                     code: "..."
                  }
               )
            ```
            - code: 商談.受注先コード(order_dest_code)
            - 各項目のマッピングは[取引先シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 「管轄支店」: 商談.管轄支店(branch_code)を選択
      -  担当部署プルダウンの作成  
         [42.部署API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/42.%E9%83%A8%E7%BD%B2.md)の[getDepartments](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/42.%E9%83%A8%E7%BD%B2.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
         #### リクエストパラメータ
         ```json
            getDepartments(
               request: {
                  branch_code: "...",
                  sort_column1: "...",
                  order1: "..."
               }
            )
         ```
         - branch_code: 商談.管轄支店(branch_code)
         - sort_column1: 「管轄支店」が未設定('')場合："表示順"、未設定('')以外の場合："部署コード"
         - order1: "asc"
         - 各項目のマッピングは[部署シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
         - 部署APIで取得した情報一覧の「部署コード(code)」及び「部署名(name)」をもとにプルダウンを生成し、商談.担当部署(department_code)の値を選択  
           一致する情報がなかった場合、未設定('')の選択肢のみのプルダウンを生成  
      - 担当者プルダウンの作成  
         [41.社員API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/41.%E7%A4%BE%E5%93%A1.md)の[getEmployees](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/41.%E7%A4%BE%E5%93%A1.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象情報一覧を取得
         #### リクエストパラメータ
         ```json
            getEmployees(
               request: {
                  department_code: "...",
                  sort_column1: "...",
                  order1: "..."
               }
            )
         ```
         - department_code: 商談.担当部署(department_code)
         - sort_column1: "社員コード"
         - order1: "asc"
         - 各項目のマッピングは[社員シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
         - 取得した情報一覧のうち、「社員コード(code)」及び「社員名(name) ※」をもとにプルダウンを生成し、商談.担当者(owner_code)を選択  
           一致する情報がなかった場合、未設定('')の選択肢のみのプルダウンを生成  
             ※但し、「退職区分(retire_kind)」が'1'の社員については、「社員名」の先頭に'★'を追記  
      - 「受注日」: ''を設定
      - 「マーク」: ''を設定
      - 「搬入時間」：''を設定
      - 「検査時間」：''を設定
      - 「受注先名」：商談.受注先コード(order_dest_code)にリレーションされている取引先.取引先名(name)を設定。商談.受注先コード(order_dest_code)が未設定('')の場合、''を設定
      - 「受注先コード」：商談.受注先コード(order_dest_code)を設定
      - 「受注先住所（郵便番号）」：商談.受注先郵便番号(order_dest_postcode)を設定
      - 「受注先住所（住所）」：商談.受注先住所(order_dest_address)を設定
      - 「工事担当者」：''を設定
      - 「工事引渡日」：商談.工事引渡予定日(work_delivery_plan_at)をYYYY/MM/DD形式にて設定
      - 「受注先担当部署」：商談.受注先担当部署(order_dest_department)を設定
      - 「受注先担当者」：商談.受注先担当者(order_dest_owner)を設定
      - 「受注先電話番号」：商談.受注先電話番号(order_dest_tel)を設定
      - 「受注先FAX番号」：商談.受注先ＦＡＸ番号(order_dest_fax)を設定
      - 「工期（開始）」：''を設定
      - 「工期（終了）」：''を設定
      - 「タンク引渡日」：商談.タンク引渡予定日(tank_delivery_plan_at)をYYYY/MM/DD形式にて設定
      - 「決定」：チェックボックスをFalseに設定
      - 「タンク引渡日２」：''を設定し、入力域を読み取り専用に設定
      - 「決定２」：チェックボックスをFalseに設定
      - 「タンク引渡日３」：''を設定、入力域を読み取り専用に設定
      - 「決定３」：チェックボックスをFalseに設定
      - 「完了日」：''を設定
      - 「受注金額」：商談.受注予定金額(order_plan_amount)を3桁毎の','区切り表記（例：1,500）で設定
      - 「実行予算合計」：商談明細APIで取得した商談明細情報一覧の「実行予算(budget)」の合計値を3桁毎の','区切り表記（例：1,500）で設定
      - 「粗利額（金額）」：「受注金額 - 実行予算合計」の計算結果を3桁毎の','区切り表記（例：1,500）で設定
      - 「粗利額（割合）」：「（粗利額（金額）/ 受注金額 ）* 100」の計算結果を小数点第三位にて四捨五入して小数点第ニ位までを設定  
           ※受注金額が0円の場合は、粗利額（割合）は算出せず、'0.00'を設定  
      - 「見積番号」：商談.見積番号(estimate_no)を設定
      - 「所轄行政」：商談.所轄行政(site_gov)を設定
      - 「現場名」：商談.現場名(site_name)を設定
      - 「現場電話番号」：商談.現場電話番号(site_tel)を設定
      - 「現場FAX番号」：商談.現場ＦＡＸ番号(site_fax)を設定
      - 「現場地域」：商談.現場地域(site_area)を設定
      - 「給油所等の別」：''を設定
      - 「現場住所（郵便番号）」：商談.現場郵便番号(site_postcode)を設定
      - 「現場住所（住所）」：商談.現場住所(site_address)を設定
      - 「施設名」：商談.施設名(facility_name)を設定
      - 「施設コード」：商談.施設コード(facility_code)を設定
      - 「請求予定額」：''を設定
      - 「請求金額１」：''を設定
      - 「請求日１」：''を設定
      - 「請求金額２」：''を設定
      - 「請求日２」：''を設定
      - 「請求金額３」：''を設定
      - 「請求日３」：''を設定
      - 受注先支払条件（通常）
         - 「締日」：取引先.締日(close_day)を設定   ※上記、「請求先」設定時に取得した取引先情報を利用
         - 「金種」：コードAPIで取得したコード.略称(ryaku_name)  
            [38.コードAPI](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md)の[getCodes](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いてを指定して対象レコードデータを取得
            #### リクエストパラメータ
            ```json
               getCodes(
                  request: {
                     kind_code: "...",
                     code: "..."
                  }
               )
            ```
            - kind_code: KNSY
            - code: 取引先.支払金種１(knsy_code1)
            - 各項目のマッピングは[コードシートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
         - 「サイト」：取引先.サイト１(site1)を設定
         - 「支払月」：コードAPIで取得したコード.略称(ryaku_name)  
            [38.コードAPI](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md)の[getCodes](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/38.%E3%82%B3%E3%83%BC%E3%83%89.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象レコードデータを取得
            #### リクエストパラメータ
            ```json
               getCodes(
                  request: {
                     kind_code: "...",
                     code: "..."
                  }
               )
            ```
            - kind_code: SIHA
            - code: 取引先.支払月(pay_month)
            - 各項目のマッピングは[コードシートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
         - 「支払日」：取引先.支払日(pay_day)を設定
      - 「注文書有無」：''を設定
      - 「仕訳計上」："未計上"を設定
      - 「特記事項」：''を設定
      - 「請求済金額」：''を設定
      - 「支払済金額」：''を設定
      - 「粗利額（金額）」：''を設定
      - 「粗利額（割合）」：''を設定
      - 受注明細入力
         - 「No」：1から連番を設定
         - 「工種名／製品名」：商品APIで取得した商品.商品名(name)  
            [53.商品API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/53.%E5%95%86%E5%93%81.md)の[getProductByCode](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/53.%E5%95%86%E5%93%81.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象レコードデータを取得
            #### リクエストパラメータ
            ```json
               getProductByCode(
                  request: {
                     code: "..."
                  }
               )
            ```
            - code: 商談明細.製品コード
            - 各項目のマッピングは[商品シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
         - 「工種／製品コード」：商談明細.製品コード(product_code)を設定
         - 「数量」：商談明細.数量(num)を3桁毎の','区切り表記（例：1,500）で設定
         - 「単価」：商談明細.単価(unit)を3桁毎の','区切り表記（例：1,500）で設定
         - 「金額」：商談明細.金額(amount)を3桁毎の','区切り表記（例：1,500）で設定
         - 「実行予算」：商談明細.実行予算(budget)を3桁毎の','区切り表記（例：1,500）で設定
         - 「発注金額」：''を設定
         - 「予算残額」：''を設定
         - 「検収金額」：''を設定
         - 「検収残額」：''を設定
         - 「発注先（代表）」：''を設定

### 共通処理４
1. 受注ライニングにおいて、受注番号の「開始年月日(start_date)」の最小日、「終了年月日(end_date)」の最大日を取得する  
受注ライニングAPIで取得した情報一覧のうち、「開始年月日(start_date)」の最小値（' 'を除く）及び「終了年月日(end_date)」の最大値（' 'を除く）を取得する  
「該当データなし」または「エラー」の場合、未設定('')とする  
   [27.受注ライニングAPI](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/27.%E5%8F%97%E6%B3%A8%E3%83%A9%E3%82%A4%E3%83%8B%E3%83%B3%E3%82%B0.md)の[getLinings](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/27.%E5%8F%97%E6%B3%A8%E3%83%A9%E3%82%A4%E3%83%8B%E3%83%B3%E3%82%B0.md#%E3%82%AF%E3%82%A8%E3%83%AA)クエリを用いて対象レコードデータを取得
   #### リクエストパラメータ
   ```json
      getLinings(
         request: {
            order_no: "..."
         }
      )
   ```
   - order_no: 受注一覧にて受注明細が選択された行に該当する受注番号
   - 各項目のマッピングは[受注ライニングシートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
2. 受注.受注区分にリレーションされているコード.区分３(kind3)：ライニング遷移フラグ及びコード.区分４(kind4)：施設必須フラグを取得する  
3. 下記条件を満たす場合、「工事引渡日」の背景色を淡い黄色（#FFFFCC）に変更する  
   「受注区分」の先頭1桁の値が'1'または'2'
4. 下記条件を全て満たすの場合、「タンク引渡日」の背景色を淡い黄色（#FFFFCC）に変更する  
   - 「受注区分」の先頭1桁の値が'1'以外かつ'2'以外
   - 「受注区分」が「未設定('')、'61'、'64'、'71'」のいずれにも該当しない
5. 「受注区分」が'41'(水：ＦＳＦ防火水槽)または'45'(水：ＦＳＶ防火水槽)の場合、以下を行う
   - 「タンク引渡日２」：日付を入力可に設定
   - 「決定２」：チェックボックスをチェック可能に設定
   - 「タンク引渡日３」：日付を入力可に設定
   - 「決定３」：チェックボックスをチェック可能に設定
6. 「受注区分」が'41'(水：ＦＳＦ防火水槽)かつ'45'(水：ＦＳＶ防火水槽)以外の場合、以下を行う
   - 「タンク引渡日２」：日付を入力不可（読み取り専用）に設定
   - 「決定２」：チェックボックスをチェック不可に設定
   - 「タンク引渡日３」：日付を入力不可（読み取り専用）に設定
   - 「決定３」：チェックボックスをチェック不可に設定

### 受注入力情報一時保存
- ＤＢ登録
   1. 新規作成、参照作成、商談参照受注の場合
      - 受注情報の登録を行う  
         [4.受注API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/4.%E5%8F%97%E6%B3%A8.md)の[createOrder](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/4.%E5%8F%97%E6%B3%A8.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて登録
         #### リクエストパラメータ
         ```json
            createOrder(
               createInput: {
                  date: "...",
                  jucy_code: "...",
                  sysi_code: "...",
                  juke_code: "...",
                  branch_code: "...",
                  department_code: "...",
                  owner_code: "...",
                  worker_code: "...",
                  order_dest_name: "...",
                  order_dest_code: "...",
                  order_dest_postcode: "...",
                  order_dest_address: "...",
                  order_dest_department: "...",
                  order_dest_owner: "...",
                  order_dest_tel: "...",
                  order_dest_fax: "...",
                  tank_delivery_at: "...",
                  is_delivery: "...",
                  work_delivery_at: "...",
                  work_start_at: "...",
                  work_end_at: "...",
                  site_name: "...",
                  site_postcode: "...",
                  site_address: "...",
                  site_tel: "...",
                  site_fax: "...",
                  site_area: "...",
                  site_gov: "...",
                  order_amount: "...",
                  invoice1_amount: "...",
                  invoice1_at: "...",
                  invoice2_amount: "...",
                  invoice2_at: "...",
                  invoice3_amount: "...",
                  invoice3_at: "...",
                  is_form: "...",
                  special_remark: "...",
                  nego_no: "...",
                  is_ab: "...",
                  complete_at: "...",
                  changed_order_amount: "...",
                  final_invoice_amount: "...",
                  invoice_dest_code: "...",
                  is_issue_invoice: "...",
                  invoice1_no: "...",
                  invoice2_no: "...",
                  invoice3_no: "...",
                  estimate_no: "...",
                  remark: "...",
                  carry_time: "...",
                  inspection_time: "...",
                  del_flag: "...",
                  peif_code1: "...",
                  peif_code2: "...",
                  peif_code3: "...",
                  order_apply_no: "...",
                  manufacture_apply_no: "...",
                  execute_apply_no: "...",
                  kyuu_code: "...",
                  mark_code: "...",
                  facility_name: "...",
                  facility_code: "...",
                  paid_at: "...",
                  tank_delivery2_at: "...",
                  is_delivery2: "...",
                  tank_delivery3_at: "...",
                  is_delivery3: "..."
               }
            )
         ```
         - date：入力された「受注日」(YYYYMMDD形式)
         - jucy_code：選択された「受注区分」のＩＤ
         - sysi_code：選択された「受注詳細区分」のＩＤ
         - juke_code：選択された「受注形態」のＩＤ
         - branch_code：選択された「管轄支店」のＩＤ
         - department_code：選択された「担当部署」のＩＤ
         - owner_code：選択された「担当者」のＩＤ
         - worker_code：選択された「工事担当者」のＩＤ
         - order_dest_name：入力された「受注先名」
         - order_dest_code：入力された「受注先コード」
         - order_dest_postcode：入力された「受注先住所(郵便番号)」
         - order_dest_address：入力された「受注先住所(住所)」
         - order_dest_department：入力された「受注先担当部署」
         - order_dest_owner：入力された「受注先担当者」
         - order_dest_tel：入力された「受注先電話番号」
         - order_dest_fax：入力された「受注先FAX番号」
         - tank_delivery_at：入力された「タンク引渡日」(YYYYMMDD形式)
         - is_delivery：タンク引渡日の「決定」チェックボックスの値（未選択：'0'、選択：'1'）
         - work_delivery_at：入力された「工事引渡日」(YYYYMMDD形式)
         - work_start_at：入力された「工期(開始日)」(YYYYMMDD形式)
         - work_end_at：入力された「工期(終了日)」(YYYYMMDD形式)
         - site_name：入力された「現場名」
         - site_postcode：入力された「現場住所(郵便番号)」
         - site_address：入力された「現場住所(住所)」
         - site_tel：入力された「現場電話番号」
         - site_fax：入力された「現場FAX番号」
         - site_area：入力された「現場地域」
         - site_gov：入力された「所轄行政」
         - order_amount：入力された「受注金額」
         - invoice1_amount：入力された「請求金額１」
         - invoice1_at：入力された「請求日１」(YYYYMMDD形式)
         - invoice2_amount：入力された「請求金額２」
         - invoice2_at：入力された「請求日２」(YYYYMMDD形式)
         - invoice3_amount：入力された「請求金額３」
         - invoice3_at：入力された「請求日３」(YYYYMMDD形式)
         - is_form：選択された「注文書」有無のＩＤ
         - special_remark：入力された「特記事項」
         - nego_no：表示された「商談番号」
         - is_ab：''
         - complete_at：表示されている「完了日」(YYYYMMDD形式)
         - changed_order_amount：'0'
         - final_invoice_amount：'0'
         - invoice_dest_code：「請求先」に表示されている名称に紐づくコード
         - is_issue_invoice：''
         - invoice1_no：''
         - invoice2_no：''
         - invoice3_no：''
         - estimate_no：入力された「見積番号」
         - remark：入力された「備考」
         - carry_time：入力された「搬入時間」
         - inspection_time：入力された「検査時間」
         - del_flag：''
         - peif_code1：'0'
         - peif_code2：'0'
         - peif_code3：'0'
         - order_apply_no：'0'
         - manufacture_apply_no：'0'
         - execute_apply_no：'0'
         - kyuu_code：選択された「給油所等の別」のＩＤ
         - mark_code：選択された「マーク」のＩＤ
         - facility_name：入力された「施設名」
         - facility_code：入力された「施設コード」
         - paid_at：''
         - tank_delivery2_at：入力された「タンク引渡日２」(YYYYMMDD形式)
         - is_delivery2：タンク引渡日２の「決定」チェックボックスの値（未選択：'0'、選択：'1'）
         - tank_delivery3_at：入力された「タンク引渡日３」(YYYYMMDD形式)
         - is_delivery3：タンク引渡日３の「決定」チェックボックスの値（未選択：'0'、選択：'1'）
         - 各項目のマッピングは[受注シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 受注明細情報の登録を行う  
         [5.受注明細API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md)の[createOrderDetail](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて登録
         #### リクエストパラメータ
         ```json
            createOrderDetail(
               createInput: {
                  order_no: "...",
                  detail_no: "...",
                  product_code: "...",
                  num: "...",
                  unit: "...",
                  amount: "...",
                  budget: "...",
                  supplier_code: "...",
                  supplier_name: "...",
                  ordered_amount: "...",
                  paid_amount: "..."
               }
            )
         ```
         - order_no：上記の受注登録時に採番された「受注番号」
         - detail_no：1からの連番
         - product_code：受注明細入力で入力された「製品名／工種名」に紐づく製品／工種コード
         - num：受注明細入力で入力された「数量」
         - unit：受注明細入力で入力された「単価」
         - amount：受注明細入力で入力された「金額」
         - budget：受注明細入力で入力された「実行予算」
         - supplier_code：新規作成（''）、参照作成(受注明細.代表発注先コード(supplier_code))、商談参照受注（''）
         - supplier_name：新規作成（''）、参照作成(受注明細.代表発注先名(supplier_name))、商談参照受注（''）
         - ordered_amount：新規作成（''）、参照作成(受注明細.発注済金額(ordered_amount))、商談参照受注（''）
         - paid_amount：新規作成（''）、参照作成(受注明細.支払済金額(paid_amount))、商談参照受注（''）
         - 各項目のマッピングは[受注明細シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 商談情報の「完了日」及び「商談完了区分：受注成立」を登録する（商談参照受注のみ）  
         [1.商談API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/1.%E5%95%86%E8%AB%87.md)の[updateNegotiation](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/1.%E5%95%86%E8%AB%87.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて更新
         #### リクエストパラメータ
         ```json
            updateNegotiation(
               updateInput: {
                  no: "...",
                  skan_code: "..."
                  complete_at: "..."
               }
            )
         ```
         - no: 商談一覧にて選択された行に該当する商談番号
         - skan_code: '1'(受注成立)
         - complete_at: 入力された受注日(YYYYMMDD形式)
         - 各項目のマッピングは[商談シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 通知メール(SQSメッセージ)送信  
         [SQS情報(通知時)](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/common/SQS%E6%83%85%E5%A0%B1.md#%E9%80%9A%E7%9F%A5%E6%99%82)をもとに以下のパラメタを指定して通知メッセージを送信する
         - mail_id：J0001
         - order_no：上記の受注登録時に採番された「受注番号」

   2. 編集モード(受注訂正)の場合
      - 受注番号に紐づく受注明細情報の全削除を行う  
        但し、[初期表示](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E7%B7%A8%E9%9B%86%E3%83%A2%E3%83%BC%E3%83%89%E5%8F%97%E6%B3%A8%E8%A8%82%E6%AD%A3)における受注明細情報取得結果が0件だった場合は、本処理は行わない  
         [5.受注明細API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md)の[deleteOrderDetail](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて削除
         #### リクエストパラメータ
         ```json
            deleteOrderDetail(
               deleteInput: {
                  order_no: "..."
               }
            )
         ```
         - order_no: 前画面から引き継がれた受注番号
         - 各項目のマッピングは[受注明細シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 受注情報の更新を行う  
         [4.受注API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/4.%E5%8F%97%E6%B3%A8.md)の[updateOrder](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/4.%E5%8F%97%E6%B3%A8.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて更新
         #### リクエストパラメータ
         ```json
            updateOrder(
               updateInput: {
                  date: "...",
                  jucy_code: "...",
                  sysi_code: "...",
                  juke_code: "...",
                  branch_code: "...",
                  department_code: "...",
                  owner_code: "...",
                  worker_code: "...",
                  order_dest_name: "...",
                  order_dest_code: "...",
                  order_dest_postcode: "...",
                  order_dest_address: "...",
                  order_dest_department: "...",
                  order_dest_owner: "...",
                  order_dest_tel: "...",
                  order_dest_fax: "...",
                  tank_delivery_at: "...",
                  is_delivery: "...",
                  work_delivery_at: "...",
                  work_start_at: "...",
                  work_end_at: "...",
                  site_name: "...",
                  site_postcode: "...",
                  site_address: "...",
                  site_tel: "...",
                  site_fax: "...",
                  site_area: "...",
                  site_gov: "...",
                  order_amount: "...",
                  invoice1_amount: "...",
                  invoice1_at: "...",
                  invoice2_amount: "...",
                  invoice2_at: "...",
                  invoice3_amount: "...",
                  invoice3_at: "...",
                  is_form: "...",
                  special_remark: "...",
                  nego_no: "...",
                  invoice_dest_code: "...",
                  estimate_no: "...",
                  carry_time: "...",
                  inspection_time: "...",
                  del_flag: "...",
                  kyuu_code: "...",
                  mark_code: "...",
                  facility_name: "...",
                  facility_code: "...",
                  tank_delivery2_at: "...",
                  is_delivery2: "...",
                  tank_delivery3_at: "...",
                  is_delivery3: "..."
               }
            )
         ```
         - date：入力された「受注日」(YYYYMMDD形式)
         - jucy_code：選択された「受注区分」のＩＤ
         - sysi_code：選択された「受注詳細区分」のＩＤ
         - juke_code：選択された「受注形態」のＩＤ
         - branch_code：選択された「管轄支店」のＩＤ
         - department_code：選択された「担当部署」のＩＤ
         - owner_code：選択された「担当者」のＩＤ
         - worker_code：選択された「工事担当者」のＩＤ
         - order_dest_name：入力された「受注先名」
         - order_dest_code：入力された「受注先コード」
         - order_dest_postcode：入力された「受注先住所(郵便番号)」
         - order_dest_address：入力された「受注先住所(住所)」
         - order_dest_department：入力された「受注先担当部署」
         - order_dest_owner：入力された「受注先担当者」
         - order_dest_tel：入力された「受注先電話番号」
         - order_dest_fax：入力された「受注先FAX番号」
         - tank_delivery_at：入力された「タンク引渡日」(YYYYMMDD形式)
         - is_delivery：タンク引渡日の「決定」チェックボックスの値（未選択：'0'、選択：'1'）
         - work_delivery_at：入力された「工事引渡日」(YYYYMMDD形式)
         - work_start_at：入力された「工期(開始日)」(YYYYMMDD形式)
         - work_end_at：入力された「工期(終了日)」(YYYYMMDD形式)
         - site_name：入力された「現場名」
         - site_postcode：入力された「現場住所(郵便番号)」
         - site_address：入力された「現場住所(住所)」
         - site_tel：入力された「現場電話番号」
         - site_fax：入力された「現場FAX番号」
         - site_area：入力された「現場地域」
         - site_gov：入力された「所轄行政」
         - order_amount：入力された「受注金額」
         - invoice1_amount：入力された「請求金額１」
         - invoice1_at：入力された「請求日１」(YYYYMMDD形式)
         - invoice2_amount：入力された「請求金額２」
         - invoice2_at：入力された「請求日２」(YYYYMMDD形式)
         - invoice3_amount：入力された「請求金額３」
         - invoice3_at：入力された「請求日３」(YYYYMMDD形式)
         - is_form：選択された「注文書」有無のＩＤ
         - special_remark：入力された「特記事項」
         - nego_no：表示された「商談番号」
         - invoice_dest_code：「請求先」に表示されている名称に紐づくコード
         - estimate_no：入力された「見積番号」
         - carry_time：入力された「搬入時間」
         - inspection_time：入力された「検査時間」
         - del_flag：''
         - kyuu_code：選択された「給油所等の別」のＩＤ
         - mark_code：選択された「マーク」のＩＤ
         - facility_name：入力された「施設名」
         - facility_code：入力された「施設コード」
         - tank_delivery2_at：入力された「タンク引渡日２」(YYYYMMDD形式)
         - is_delivery2：タンク引渡日２の「決定」チェックボックスの値（未選択：'0'、選択：'1'）
         - tank_delivery3_at：入力された「タンク引渡日３」(YYYYMMDD形式)
         - is_delivery3：タンク引渡日３の「決定」チェックボックスの値（未選択：'0'、選択：'1'）
         - 各項目のマッピングは[受注シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 「受注明細入力」に入力された受注明細情報の全登録を行う  
         [5.受注明細API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md)の[createOrderDetail](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/5.%E5%8F%97%E6%B3%A8%E6%98%8E%E7%B4%B0.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて登録
         #### リクエストパラメータ
         ```json
            createOrderDetail(
               createInput: {
                  order_no: "...",
                  detail_no: "...",
                  product_code: "...",
                  num: "...",
                  unit: "...",
                  amount: "...",
                  budget: "...",
                  supplier_code: "...",
                  supplier_name: "...",
                  ordered_amount: "...",
                  paid_amount: "..."
               }
            )
         ```
         - order_no：前画面から引き継がれた受注番号
         - detail_no：受注明細入力の各明細に紐づく明細番号
         - product_code：受注明細入力で入力された「製品名／工種名」に紐づく製品／工種コード
         - num：受注明細入力で入力された「数量」
         - unit：受注明細入力で入力された「単価」
         - amount：受注明細入力で入力された「金額」
         - budget：受注明細入力で入力された「実行予算」
         - supplier_code：編集モード(受注明細.代表発注先コード(supplier_code))
         - supplier_name：編集モード(受注明細.代表発注先名(supplier_name))
         - ordered_amount：編集モード(受注明細.発注済金額(ordered_amount))
         - paid_amount：編集モード(受注明細.支払済金額(paid_amount))
         - 各項目のマッピングは[受注明細シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 「受注明細入力」に入力された受注明細のうち、製品コードに変更があった明細について紐づく製造仕様情報を削除する。但し、変更後の製品コードの先頭桁が'2'の場合は対象外とする
         - 条件（製造仕様.受注番号(order_no) = 受注明細.受注番号(no) かつ 製造仕様.明細番号(detail_no) = 受注明細.明細番号(detail_no)）が一致する製造仕様情報について、削除フラグを更新する  
            [8.製造仕様API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/8.%E8%A3%BD%E9%80%A0%E4%BB%95%E6%A7%98.md)の[updateManufactureSpecification](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/8.%E8%A3%BD%E9%80%A0%E4%BB%95%E6%A7%98.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて更新
            #### リクエストパラメータ
            ```json
                  updateManufactureSpecification(
                     updateInput: {
                        no: "...",
                        delete_flag: "..."
                     }
                  )
            ```
            - no: 受注明細.受注番号
            - delete_flag: '1'
            - 各項目のマッピングは[製造仕様シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
      - 通知メール(SQSメッセージ)送信  
         [SQS情報(通知時)](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/common/SQS%E6%83%85%E5%A0%B1.md#%E9%80%9A%E7%9F%A5%E6%99%82)をもとに以下のパラメタを指定して通知メッセージを送信する
         - mail_id: J0002
         - order_no: 前画面から引き継がれた受注番号
   
### 各種チェック（ライニング入力・一時保存・登録申請の各ボタン押下時）  ※処理中止時は、チェック対象の項目にフォーカスをあて終了する  
以下のチェックを行い、1～3のチェックについては複数エラーがある場合、エラーメッセージをまとめてモーダル表示する  
1. 必須項目チェック
   - 「受注日」が未設定('')の場合、「受注日が未入力です。」のエラーメッセージを表示する
   - 「受注区分」が未設定('')の場合、「受注区分が選択されていません。」のエラーメッセージを表示する
   - 「マーク」が未設定('')の場合、「マークが選択されていません。」のエラーメッセージを表示する
   - 「受注詳細区分」が未設定('')の場合、「受注詳細区分が選択されていません。」のエラーメッセージを表示する
   - 「管轄支店」が未設定('')の場合、「管轄支店が選択されていません。」のエラーメッセージを表示する
   - 「担当部署」が未設定('')の場合、「担当部署が選択されていません。」のエラーメッセージを表示する
   - 「担当者」が未設定('')の場合、「担当者が選択されていません。」のエラーメッセージを表示する
   - 「受注先」が未設定('')の場合、「受注先が選択されていません。」のエラーメッセージを表示する
   - 「受注明細入力」に明細が１件も入力されていなかった場合、「受注明細を入力してください。」のエラーメッセージを表示する（※登録申請実行時のみ）
   - 「受注明細入力」に明細が存在し、「実行予算合計」が未設定('')または'0'の場合、「実行予算を入力してください。」のエラーメッセージを表示する（※登録申請実行時のみ）
2. 項目相関チェック
   - 「工期(開始)」が未設定('')以外かつ「工期(終了)」が未設定('')以外の場合、以下をチェックする
      - 「工期(開始)」 > 「工期(終了)」の場合、「工期の大小関係に誤りがあります。」のエラーメッセージを表示する
   - 「受注金額」と「請求予定金額」を比較し一致しなかった場合、「受注金額と請求予定額の関係に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「搬入時間」が"00:00"～"24:00"以外の場合、「搬入時間に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「検査時間」が"00:00"～"24:00"以外の場合、「検査時間に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「タンク引渡日」が未設定('')以外かつ「受注日」 > 「タンク引渡日」の場合、「受注日とタンク引渡日の関係に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「タンク引渡日」が未設定('')以外かつ「工事引渡日」が未設定('')以外かつ「タンク引渡日」 > 「工事引渡日」の場合、「タンク引渡日と工事引渡日の関係に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「工期(開始)」が未設定('')以外かつ「受注日」 > 「工期(開始)」の場合、「受注日と工期開始の関係に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「工事引渡日」が未設定('')以外かつ「工期(終了)」が未設定('')以外かつ「工事引渡日」 < 「工期(終了)」の場合、「工事引渡日と工期終了日の関係に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「受注区分」の先頭1桁の値が'1'または'2'の場合、以下をチェックする
      - 「工事引渡日」が未設定('')の場合、「工事引渡日が未入力です。」のエラーメッセージを表示して処理を中止する
      - 「工期(開始)」が未設定('')または「工期(終了)」が未設定('')の場合、「工事受注は工期が必須です。」のエラーメッセージを表示して処理を中止する
   - 「受注区分」の先頭1桁の値が'1'以外かつ'2'以外の場合、以下をチェックする
      - 「受注区分」が'61'以外かつ'64'以外かつ'71'以外かつ「タンク引渡日」が未設定('')の場合、「タンク引渡日が未入力です。」のエラーメッセージを表示して処理を中止する
3. 受注明細入力チェック
   - 「工種名／製品名」が未入力("")以外かつ「工種／製品コード」が未入力("")の場合、「工種名／製品名の入力に誤りがあります。」のエラーメッセージを表示して処理を中止する
   - 「工種名／製品名」が未入力("")以外かつ「工種／製品コード」が未入力("")以外かつ「数量」または「単価」または「金額」または「実行予算」のいずれかが未入力("")以外の場合、以下をチェックする
      - 「工種／製品コード」の先頭1桁の値が'2'の場合、以下をチェックする
         - 「数量」が未入力("")または'0'の場合、「数量･金額に誤りがあります。」のエラーメッセージを表示して処理を中止する
         - 「タンク引渡日」が未設定('')の場合、「明細にタンクがある場合、タンク引渡日は必須です。」のエラーメッセージを表示して処理を中止する
      - 「工種／製品コード」が"199000200"以外かつ「発注金額」が'0'以外の場合、以下をチェックする
         - 「発注金額」 > 「実行予算」の場合、「実行予算が発注金額を下回ります。」のエラーメッセージを表示して処理を中止する
      - 「工種／製品コード」が"199000200"以外かつ「検収金額」が'0'以外の場合、以下をチェックする
         - 「検収金額」 > 「実行予算」の場合、「実行予算が検収金額を下回ります。」のエラーメッセージを表示して処理を中止する
      - 「工種／製品コード」が"199000200"以外かつ「発注金額」が'0'以外かつ「検収金額」が'0'以外の場合、以下をチェックする
         - 「発注金額」と「検収金額」の合計値 > 「実行予算」の場合、「実行予算が実行済金額を下回ります。」のエラーメッセージを表示して処理を中止する
4. 処理継続チェック
   - 「工期(開始)」が未設定('')以外かつ「工期(終了)」が未設定('')以外の場合、以下をチェックする
      - [共通処理４](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%94)で取得した受注ライニングの「開始年月日」と「終了年月日」について以下の条件をチェックし該当した場合、「ライニングの工期が受注工期の範囲外になります。よろしいですか？」の確認メッセージ（ＯＫ・キャンセル）を表示する
         - ＜条件＞
            - 「開始年月日」が未設定('')以外かつ「開始年月日」 < 「工期(開始)」
            - 「開始年月日」が未設定('')以外かつ「開始年月日」 > 「工期(終了)」
            - 「終了年月日」が未設定('')以外かつ「終了年月日」 < 「工期(開始)」
            - 「終了年月日」が未設定('')以外かつ「終了年月日」 > 「工期(終了)」
         - ＯＫの場合、処理を継続し、キャンセルの場合、処理を中止する
   - [共通処理４](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E5%85%B1%E9%80%9A%E5%87%A6%E7%90%86%EF%BC%94)または[項目値の入力・変更に伴う処理](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#%E9%A0%85%E7%9B%AE%E5%80%A4%E3%81%AE%E5%85%A5%E5%8A%9B%E5%A4%89%E6%9B%B4%E3%81%AB%E4%BC%B4%E3%81%86%E5%87%A6%E7%90%86)の「3. 受注区分」にて変更時に取得した施設必須フラグが"1"以外の場合、以下を行う  
      - 「施設名」が未設定('')の場合、「施設名を入力してください」のメッセージを入力域の下部に表示する
      - 「施設」が未設定('')以外の場合、「選択された受注区分の場合、施設入力は必須です。施設を新規に登録しますか？」の確認メッセージを表示する
         - ＯＫの場合、入力された施設名にて施設の新規登録を行う  
            [18.施設API](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/18.%E6%96%BD%E8%A8%AD.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)の[createFacility](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/api/graphql/18.%E6%96%BD%E8%A8%AD.md#%E3%83%9F%E3%83%A5%E3%83%BC%E3%83%86%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)ミューテーションを用いて更新
            #### リクエストパラメータ
            ```json
               createFacility(
                  createInput: {
                     name: "...",
                     address: "..."
                  }
               )
            ```
            - name: 入力された施設名
            - address: 入力された現場住所
            - 各項目のマッピングは[施設シートの備考を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/schema/%E3%82%B9%E3%82%AD%E3%83%BC%E3%83%9E%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%A8%AD%E8%A8%88%E6%9B%B8.xlsx)
         - キャンセルの場合、処理を中止する
   - 編集モード(受注訂正)の場合のみ、以下を行う
      - [32．ステータス表示](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/7.%E5%8F%97%E6%B3%A8%E5%85%A5%E5%8A%9B.md#32-%E3%82%B9%E3%83%86%E3%83%BC%E3%82%BF%E3%82%B9%E8%A1%A8%E7%A4%BA)で取得したステータス(受注.受注ＰＥ申請フラグ(peif_code)に紐づくコード.略称(ryaku_name))が「決裁」で「受注金額」または「実行予算合計」が初期表示の金額から変更があった場合、「金額に変更がある場合は、再申請が必要です」のエラーメッセージを表示して処理を中止する
5. 処理継続確認メッセージ出力
呼出しボタン毎に処理継続の確認メッセージ（ＯＫ・キャンセル）を表示する
   - 確認メッセージ内容
      - ライニング入力ボタン
         - 「一時保存してライニング入力に遷移します。よろしいですか？」
      - 一時保存ボタン
         - 「一時保存してよろしいですか？」
      - 登録申請ボタン
         - 「申請してよろしいですか？」
   - ＯＫの場合は処理を継続し、キャンセルの場合は処理を中止する

## 項目値の入力・変更に伴う処理  
1. 現場住所(郵便番号)  
   - 入力または変更時、[住所取得API](https://github.com/ljs-shimizu/ljs-tank-estimate/blob/main/docs/s_step2API%E4%BB%95%E6%A7%98/00_%E5%85%B1%E9%80%9A.md#%E4%BD%8F%E6%89%80%E5%8F%96%E5%BE%97-api)を用いて住所情報を取得し、「現場住所(住所)」に設定する
   - 住所取得APIがエラーとなった(該当する郵便番号が存在しない)場合は、「入力された郵便番号は存在しません」のエラーメッセージを表示する
   - 入力されている現場住所(郵便番号)がクリアされても「現場住所(住所)」はクリアしない
2. 下記条件を満たす場合、「工事引渡日」の背景色を淡い黄色（#FFFFCC）に変更する  
   「受注区分」の先頭1桁の値が'1'または'2'
3. 下記条件を全て満たすの場合、「タンク引渡日」の背景色を淡い黄色（#FFFFCC）に変更する  
   - 「受注区分」の先頭1桁の値が'1'以外かつ'2'以外
   - 「受注区分」が「未設定('')、'61'、'64'、'71'」のいずれにも該当しない
4. 受注区分
   - 変更時、選択されている受注区分をもとにコード.区分３(kind3)：ライニング遷移フラグ及びコード.区分４(kind4)：施設必須フラグを取得する  
      [こちらの仕様を参照](https://github.com/ljs-shimizu/tamada-coresystem-docs/blob/develop/spec/front/3.%E5%95%86%E8%AB%87%E4%B8%80%E8%A6%A7.md#2-%E3%82%B3%E3%83%BC%E3%83%89%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%97%E3%83%AB%E3%83%80%E3%82%A6%E3%83%B3)
5. 受注先コードが設定された場合、以下を設定する
   - 「受注先名」：受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先名(name)
   - 「請求先」：受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先名(name)
   - 「受注先住所（郵便番号）」：受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先郵便番号(postcode)
   - 「受注先住所（住所）」：受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先.取引先住所(address)
   - 「受注先電話番号」：受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先電話番号(tel)
   - 「受注先FAX番号」：受注.受注先コード(order_dest_code)にリレーションされている取引先.取引先ＦＡＸ番号(fax)
   - 受注先支払条件（通常）
      - 「締日」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.締日(close_day)
      - 「金種」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.支払金種１(knsy_code1)
      - 「サイト」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.サイト１(site1)
      - 「支払月」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.支払月(pay_month)
      - 「支払日」：受注.受注先コード(order_dest_code)にてリレーションされている取引先.支払日(pay_day)

