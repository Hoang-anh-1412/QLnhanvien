# 8. 作業服注文API

**バージョン:** v0.1  
**最終更新:** 2025-10-25  
**作成者:** Chính  
**レビュー担当:** [PM/Leader Name]  
**システム:** 人事管理  

---

## 1. 概要
社員の作業服注文を管理するAPI（作業服注文）- 注文、確認、納品の全プロセスを管理します。

**データベーステーブル:** `T_作業服注文`（作成が必要）

---

## 2. エンドポイント

### 2.1. 作業服注文リスト取得
- **API Call:** `GET /api/v1/work-uniform-orders`
- **説明:** すべての作業服注文のリストを取得
- **クエリパラメータ:**
  - `page` (number, optional): ページ番号（デフォルト: 1）
  - `size` (number, optional): ページサイズ（デフォルト: 20、最大: 100）
  - `divisionName` (string, optional): 統括部門名でフィルタ
  - `departmentName` (string, optional): 部署名でフィルタ
  - `employeeName` (string, optional): 社員名でフィルタ
  - `orderDateFrom` (string, optional): 注文日からフィルタ（YYYY-MM-DD）
  - `orderDateTo` (string, optional): 注文日までフィルタ（YYYY-MM-DD）
  - `status` (string, optional): ステータスでフィルタ
  - `sort` (string, optional): ソート順（デフォルト: orderDate,desc）

**Response Data Type:**
```typescript
interface WorkUniformOrder {
  orderCode: string;
  employeeCode: string;
  employeeName: string;
  divisionName: string;
  departmentName: string;
  orderDate: string;
  deliveryDate?: string;
  status: 'pending' | 'confirmed' | 'delivered' | 'cancelled';
  totalAmount: number;
  items: WorkUniformItem[];
  remarks?: string;
  createdAt: string;
  updatedAt: string;
}

interface WorkUniformItem {
  itemCode: string;
  itemName: string;
  size: string;
  color: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
}

interface WorkUniformOrderListResponse {
  success: true;
  data: WorkUniformOrder[];
  message: "作業服注文リストの取得に成功しました";
  pagination: {
    page: number;
    size: number;
    totalElements: number;
    totalPages: number;
    hasNext: boolean;
    hasPrevious: boolean;
  };
}
```

**Example Response:**
```json
{
  "success": true,
  "data": [
    {
      "orderCode": "WO2025001",
      "employeeCode": "000893",
      "employeeName": "佐藤 悠",
      "divisionName": "東日本支店",
      "departmentName": "AA一課",
      "orderDate": "2025-04-14",
      "deliveryDate": "2025-04-21",
      "status": "pending",
      "totalAmount": 150000,
      "items": [
        {
          "itemCode": "UF001",
          "itemName": "作業服 上下セット",
          "size": "M",
          "color": "ネイビー",
          "quantity": 2,
          "unitPrice": 75000,
          "totalPrice": 150000
        }
      ],
      "remarks": "緊急対応",
      "createdAt": "2025-04-14T10:30:00Z",
      "updatedAt": "2025-04-14T10:30:00Z"
    }
  ],
  "message": "作業服注文リストの取得に成功しました",
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 5989,
    "totalPages": 300,
    "hasNext": true,
    "hasPrevious": false
  }
}
```

### 2.2. 注文コードによる作業服注文取得
- **API Call:** `GET /api/v1/work-uniform-orders/{orderCode}`
- **説明:** 作業服注文の詳細情報を取得
- **パスパラメータ:**
  - `orderCode` (string, required): 注文コード

**Response Data Type:**
```typescript
interface WorkUniformOrderDetailResponse {
  success: true;
  data: WorkUniformOrder;
  message: "作業服注文の詳細取得に成功しました";
}
```

### 2.3. 新規作業服注文作成
- **API Call:** `POST /api/v1/work-uniform-orders`
- **説明:** 新しい作業服注文を作成
- **Request Data Type:**
```typescript
interface CreateWorkUniformOrderRequest {
  employeeCode: string;
  orderDate: string;
  deliveryDate?: string;
  items: {
    itemCode: string;
    size: string;
    color: string;
    quantity: number;
  }[];
  remarks?: string;
}
```

**Response Data Type:**
```typescript
interface CreateWorkUniformOrderResponse {
  success: true;
  data: WorkUniformOrder;
  message: "作業服注文の作成に成功しました";
}
```

### 2.4. 作業服注文更新
- **API Call:** `PUT /api/v1/work-uniform-orders/{orderCode}`
- **説明:** 作業服注文情報を更新
- **パスパラメータ:**
  - `orderCode` (string, required): 注文コード
- **Request Data Type:**
```typescript
interface UpdateWorkUniformOrderRequest {
  deliveryDate?: string;
  status: 'pending' | 'confirmed' | 'delivered' | 'cancelled';
  items: {
    itemCode: string;
    size: string;
    color: string;
    quantity: number;
  }[];
  remarks?: string;
}
```

**Response Data Type:**
```typescript
interface UpdateWorkUniformOrderResponse {
  success: true;
  data: WorkUniformOrder;
  message: "作業服注文の更新に成功しました";
}
```

### 2.5. 作業服注文削除
- **API Call:** `DELETE /api/v1/work-uniform-orders/{orderCode}`
- **説明:** 作業服注文を削除（ソフト削除）
- **パスパラメータ:**
  - `orderCode` (string, required): 注文コード

**Response Data Type:**
```typescript
interface DeleteWorkUniformOrderResponse {
  success: true;
  data: null;
  message: "作業服注文の削除に成功しました";
}
```

### 2.6. 注文ステータス更新
- **API Call:** `PATCH /api/v1/work-uniform-orders/{orderCode}/status`
- **説明:** 作業服注文のステータスを更新
- **パスパラメータ:**
  - `orderCode` (string, required): 注文コード
- **Request Data Type:**
```typescript
interface UpdateOrderStatusRequest {
  status: 'pending' | 'confirmed' | 'delivered' | 'cancelled';
  remarks?: string;
}
```

---

## 3. エラーレスポンス

### 3.1. バリデーションエラー
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "code": "WUO_001",
  "message": "入力データが無効です",
  "details": [
    {
      "field": "employeeCode",
      "message": "社員コードは必須です",
      "code": "FIELD_REQUIRED"
    },
    {
      "field": "items",
      "message": "商品リストは空にできません",
      "code": "INVALID_ITEMS"
    }
  ]
}
```

### 3.2. 見つからないエラー
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "code": "WUO_002",
  "message": "作業服注文が見つかりません",
  "details": []
}
```

### 3.3. 競合エラー
```json
{
  "success": false,
  "error": "CONFLICT",
  "code": "WUO_003",
  "message": "注文コードが既に存在します",
  "details": []
}
```

---

## 4. ビジネスルール

### 4.1. バリデーションルール
- **employeeCode:** 必須、システム内に存在する必要があります
- **orderDate:** 必須、30日以上先の日付は不可
- **deliveryDate:** オプション、orderDateより後の日付である必要があります
- **items:** 必須、少なくとも1つの商品
- **status:** 事前定義された値のみ許可

### 4.2. 制約
- 納品済みの注文（status = 'delivered'）は削除できません
- キャンセルされた注文（status = 'cancelled'）は修正できません
- 商品に基づいて合計金額を自動計算

### 4.3. 権限
- **hr:read:** 注文リストと詳細の表示
- **hr:write:** 注文の作成、更新
- **hr:admin:** 注文の削除、ステータス更新

---

## 5. データベーススキーマ

### 5.1. テーブル構造
```sql
CREATE TABLE T_作業服注文 (
    注文コード VARCHAR2(50 CHAR) PRIMARY KEY,
    社員コード VARCHAR2(50 CHAR),
    注文日 DATE,
    納入日 DATE,
    ステータス VARCHAR2(20 CHAR),
    合計金額 NUMBER(12, 2),
    備考 VARCHAR2(255 CHAR),
    作成日時 TIMESTAMP,
    更新日時 TIMESTAMP,
    CONSTRAINT FK_作業服注文_社員 FOREIGN KEY (社員コード) REFERENCES T_社員マスタ(社員コード)
);

CREATE TABLE T_作業服注文明細 (
    ID NUMBER(10) PRIMARY KEY,
    注文コード VARCHAR2(50 CHAR),
    商品コード VARCHAR2(50 CHAR),
    サイズ VARCHAR2(20 CHAR),
    色 VARCHAR2(20 CHAR),
    数量 NUMBER(5),
    単価 NUMBER(10, 2),
    小計 NUMBER(12, 2),
    CONSTRAINT FK_注文明細_注文 FOREIGN KEY (注文コード) REFERENCES T_作業服注文(注文コード)
);
```

### 5.2. インデックス
- `IDX_作業服注文_社員コード` on `T_作業服注文(社員コード)`
- `IDX_作業服注文_注文日` on `T_作業服注文(注文日)`
- `IDX_作業服注文_ステータス` on `T_作業服注文(ステータス)`

---

## 6. パフォーマンス考慮事項

### 6.1. キャッシング
- 注文リストを5分間キャッシュ
- 変更時にキャッシュを無効化

### 6.2. ページネーション
- デフォルト20アイテム/ページ
- 最大100アイテム/ページ
- Oracle用にOFFSET/LIMITを使用

---

## 7. テストシナリオ

### 7.1. ハッピーパス
1. 注文リストの取得に成功
2. 新規注文の作成に成功
3. 注文の更新に成功
4. 注文ステータスの更新に成功

### 7.2. エラーケース
1. 存在しない社員コードで注文を作成
2. 存在しない注文を更新
3. 納品済み注文を削除
4. 必須フィールドが不足している場合のバリデーションエラー

---

*このAPIはRESTfulルールとREADME.mdの標準に従います*
