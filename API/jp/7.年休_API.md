# 4. 年休 API

## 概要
年休データ（T_年休詳細）を管理するAPIです。年休申請、承認、追跡を含む包括的な年休管理機能を提供します。

## ベースURL
`/api/v1/annual-leaves`

## 認証
すべてのエンドポイントでBearer Tokenが必要です

## データモデル

### 年休エンティティ
```json
{
  "id": "number",                     // ID (主キー)
  "employeeCode": "string",           // 社員コード (外部キー)
  "leaveYear": "number",              // 年休年度
  "totalDays": "number",              // 年休日数
  "usedDays": "number",               // 使用日数
  "remainingDays": "number",          // 残日数
  "carryOverDays": "number",          // 繰越日数
  "grantedDays": "number",            // 付与日数
  "expiredDays": "number",            // 失効日数
  "remarks": "string"                 // 備考
}
```

### 年休申請エンティティ
```json
{
  "requestId": "string",              // 申請ID
  "employeeCode": "string",           // 社員コード
  "leaveType": "string",              // 休暇種別
  "startDate": "date",                // 開始日
  "endDate": "date",                  // 終了日
  "days": "number",                   // 日数
  "reason": "string",                 // 理由
  "status": "string",                 // ステータス
  "approverCode": "string",           // 承認者コード
  "approvedAt": "datetime",           // 承認日時
  "createdAt": "datetime",            // 作成日時
  "updatedAt": "datetime"             // 更新日時
}
```

## エンドポイント

### 1. 全年休取得
**GET** `/api/v1/annual-leaves`

#### クエリパラメータ
- `page` (任意): ページ番号 (デフォルト: 1)
- `size` (任意): ページサイズ (デフォルト: 20)
- `employeeCode` (任意): 社員コードでフィルタ
- `year` (任意): 年休年度でフィルタ
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 5,
      "remainingDays": 15,
      "carryOverDays": 2,
      "grantedDays": 18,
      "expiredDays": 0,
      "remarks": "新入社員"
    },
    {
      "id": 2,
      "employeeCode": "EMP002",
      "employeeName": "佐藤花子",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 12,
      "remainingDays": 8,
      "carryOverDays": 0,
      "grantedDays": 20,
      "expiredDays": 0,
      "remarks": "ベテラン社員"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

### 2. 年休IDで取得
**GET** `/api/v1/annual-leaves/{id}`

#### パスパラメータ
- `id`: 年休ID

#### レスポンス
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "田中太郎",
    "leaveYear": 2024,
    "totalDays": 20,
    "usedDays": 5,
    "remainingDays": 15,
    "carryOverDays": 2,
    "grantedDays": 18,
    "expiredDays": 0,
    "remarks": "新入社員"
  }
}
```

### 3. 社員の年休取得
**GET** `/api/v1/annual-leaves/employee/{employeeCode}`

#### パスパラメータ
- `employeeCode`: 社員コード

#### クエリパラメータ
- `year` (任意): 年休年度 (デフォルト: 当年)

#### レスポンス
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "田中太郎",
    "leaveYear": 2024,
    "totalDays": 20,
    "usedDays": 5,
    "remainingDays": 15,
    "carryOverDays": 2,
    "grantedDays": 18,
    "expiredDays": 0,
    "remarks": "新入社員",
    "leaveHistory": [
      {
        "date": "2024-03-15",
        "days": 1,
        "type": "年次有給休暇",
        "status": "承認済み"
      },
      {
        "date": "2024-04-20",
        "days": 2,
        "type": "年次有給休暇",
        "status": "承認済み"
      }
    ]
  }
}
```

### 4. 年休作成
**POST** `/api/v1/annual-leaves`

#### リクエストボディ
```json
{
  "employeeCode": "EMP003",
  "leaveYear": 2024,
  "totalDays": 20,
  "usedDays": 0,
  "remainingDays": 20,
  "carryOverDays": 0,
  "grantedDays": 20,
  "expiredDays": 0,
  "remarks": "新入社員の年休設定"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "年休が正常に作成されました",
  "data": {
    "id": 3,
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 5. 年休更新
**PUT** `/api/v1/annual-leaves/{id}`

#### パスパラメータ
- `id`: 年休ID

#### リクエストボディ
```json
{
  "totalDays": 22,
  "usedDays": 3,
  "remainingDays": 19,
  "carryOverDays": 2,
  "grantedDays": 20,
  "expiredDays": 0,
  "remarks": "年休日数更新"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "年休が正常に更新されました",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-15T11:00:00Z"
  }
}
```

### 6. 年休削除
**DELETE** `/api/v1/annual-leaves/{id}`

#### パスパラメータ
- `id`: 年休ID

#### レスポンス
```json
{
  "success": true,
  "message": "年休が正常に削除されました"
}
```

### 7. 年休申請
**POST** `/api/v1/annual-leaves/request`

#### リクエストボディ
```json
{
  "employeeCode": "EMP001",
  "leaveType": "年次有給休暇",
  "startDate": "2024-05-15",
  "endDate": "2024-05-17",
  "days": 3,
  "reason": "家族旅行"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "年休申請が正常に提出されました",
  "data": {
    "requestId": "REQ2024001",
    "status": "申請中",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 8. 年休申請承認/却下
**PUT** `/api/v1/annual-leaves/request/{requestId}/status`

#### パスパラメータ
- `requestId`: 年休申請ID

#### リクエストボディ
```json
{
  "status": "承認済み",
  "approverCode": "MGR001",
  "comments": "承認します"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "年休申請ステータスが正常に更新されました",
  "data": {
    "requestId": "REQ2024001",
    "status": "承認済み",
    "approvedAt": "2024-01-15T11:00:00Z"
  }
}
```

### 9. 年休申請一覧取得
**GET** `/api/v1/annual-leaves/requests`

#### クエリパラメータ
- `page` (任意): ページ番号 (デフォルト: 1)
- `size` (任意): ページサイズ (デフォルト: 20)
- `employeeCode` (任意): 社員でフィルタ
- `status` (任意): ステータスでフィルタ
- `startDate` (任意): 開始日でフィルタ
- `endDate` (任意): 終了日でフィルタ

#### レスポンス
```json
{
  "data": [
    {
      "requestId": "REQ2024001",
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "leaveType": "年次有給休暇",
      "startDate": "2024-05-15",
      "endDate": "2024-05-17",
      "days": 3,
      "reason": "家族旅行",
      "status": "承認済み",
      "approverCode": "MGR001",
      "approvedAt": "2024-01-15T11:00:00Z",
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 50,
    "totalPages": 3
  }
}
```

### 10. 年休統計取得
**GET** `/api/v1/annual-leaves/statistics`

#### クエリパラメータ
- `year` (任意): 年休年度 (デフォルト: 当年)
- `departmentId` (任意): 部署でフィルタ
- `divisionId` (任意): 部門でフィルタ

#### レスポンス
```json
{
  "data": {
    "year": 2024,
    "totalEmployees": 100,
    "totalLeaveDays": 2000,
    "usedLeaveDays": 1200,
    "remainingLeaveDays": 800,
    "averageUsageRate": 60.0,
    "leaveByMonth": [
      {
        "month": "1月",
        "usedDays": 150,
        "percentage": 12.5
      },
      {
        "month": "2月",
        "usedDays": 120,
        "percentage": 10.0
      }
    ],
    "leaveByDepartment": [
      {
        "departmentName": "営業部",
        "totalDays": 400,
        "usedDays": 250,
        "usageRate": 62.5
      },
      {
        "departmentName": "開発部",
        "totalDays": 300,
        "usedDays": 180,
        "usageRate": 60.0
      }
    ]
  }
}
```

### 11. 年休検索
**GET** `/api/v1/annual-leaves/search`

#### クエリパラメータ
- `keyword` (必須): 検索キーワード
- `year` (任意): 年でフィルタ
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "departmentName": "営業部",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 5,
      "remainingDays": 15
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 25,
    "totalPages": 2
  }
}
```

### 12. 年休一括更新
**PUT** `/api/v1/annual-leaves/bulk-update`

#### リクエストボディ
```json
{
  "updates": [
    {
      "id": 1,
      "totalDays": 22,
      "usedDays": 3,
      "remainingDays": 19
    },
    {
      "id": 2,
      "totalDays": 20,
      "usedDays": 8,
      "remainingDays": 12
    }
  ]
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "年休が正常に更新されました",
  "data": {
    "updatedCount": 2,
    "failedCount": 0,
    "errors": []
  }
}
```

### 13. 年休カレンダー取得
**GET** `/api/v1/annual-leaves/calendar`

#### クエリパラメータ
- `year` (任意): 年 (デフォルト: 当年)
- `month` (任意): 月 (デフォルト: 当月)
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
```json
{
  "data": {
    "year": 2024,
    "month": 5,
    "calendar": [
      {
        "date": "2024-05-01",
        "isHoliday": true,
        "leaveRequests": [
          {
            "employeeCode": "EMP001",
            "employeeName": "田中太郎",
            "leaveType": "年次有給休暇",
            "status": "承認済み"
          }
        ]
      },
      {
        "date": "2024-05-02",
        "isHoliday": false,
        "leaveRequests": []
      }
    ]
  }
}
```

### 14. 年休データエクスポート
**GET** `/api/v1/annual-leaves/export`

#### クエリパラメータ
- `format` (任意): エクスポート形式 (csv, excel) (デフォルト: excel)
- `year` (任意): 年休年度
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
指定された形式で年休データのファイルダウンロード

## エラーレスポンス

### 400 Bad Request
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "入力データが無効です",
  "details": [
    {
      "field": "totalDays",
      "message": "年休日数は正の数である必要があります"
    }
  ]
}
```

### 404 Not Found
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "年休記録が見つかりません"
}
```

### 409 Conflict
```json
{
  "success": false,
  "error": "CONFLICT",
  "message": "年休申請が既存の年休と競合します"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "INTERNAL_ERROR",
  "message": "予期しないエラーが発生しました"
}
```

## ビジネスルール

1. **年休計算**: 残日数 = 年休日数 - 使用日数
2. **繰越**: 最大5日まで翌年に繰越可能
3. **年休申請**: 最低1日前に申請が必要
4. **承認**: 管理者のみが年休申請を承認可能
5. **失効**: 未使用年休は年末に失効（繰越分除く）
6. **連続日数**: 特別承認なしで最大5日まで連続取得可能

## データベース制約

- 主キー: `ID`
- 外部キー: `社員コード` → `T_社員マスタ.社員コード`
- 正の値のチェック制約
- 社員コードと年の組み合わせの一意制約

## 使用例

### 特定社員の年休取得
```bash
curl -X GET "https://api.company.com/api/v1/annual-leaves/employee/EMP001?year=2024" \
  -H "Authorization: Bearer your-token"
```

### 年休申請
```bash
curl -X POST "https://api.company.com/api/v1/annual-leaves/request" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeCode": "EMP001",
    "leaveType": "年次有給休暇",
    "startDate": "2024-05-15",
    "endDate": "2024-05-17",
    "days": 3,
    "reason": "家族旅行"
  }'
```

### 年休統計取得
```bash
curl -X GET "https://api.company.com/api/v1/annual-leaves/statistics?year=2024" \
  -H "Authorization: Bearer your-token"
```

---

*このAPIドキュメントは社員管理システムの一部です*
