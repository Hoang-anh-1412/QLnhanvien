# 5. 溶接免許 API

## 概要
溶接免許データ（T_溶接免許）を管理するAPIです。免許登録、検証、追跡を含む包括的な溶接免許管理機能を提供します。

## ベースURL
`/api/v1/welding-licenses`

## 認証
すべてのエンドポイントでBearer Tokenが必要です

## データモデル

### 溶接免許エンティティ
```json
{
  "id": "number",                     // ID (主キー)
  "employeeCode": "string",           // 社員コード (外部キー)
  "licenseNumber": "string",          // 免許番号
  "licenseType": "string",            // 免許種別
  "issueDate": "date",                // 交付日
  "expiryDate": "date",               // 有効期限
  "issuingAuthority": "string",       // 交付機関
  "status": "string",                 // ステータス
  "remarks": "string"                 // 備考
}
```

### 免許更新エンティティ
```json
{
  "renewalId": "string",              // 更新ID
  "licenseId": "number",              // 免許ID
  "renewalDate": "date",              // 更新日
  "newExpiryDate": "date",            // 新有効期限
  "renewalReason": "string",          // 更新理由
  "status": "string",                 // ステータス
  "processedBy": "string",            // 処理者
  "processedAt": "datetime",          // 処理日時
  "createdAt": "datetime"             // 作成日時
}
```

## エンドポイント

### 1. 全溶接免許取得
**GET** `/api/v1/welding-licenses`

#### クエリパラメータ
- `page` (任意): ページ番号 (デフォルト: 1)
- `size` (任意): ページサイズ (デフォルト: 20)
- `employeeCode` (任意): 社員コードでフィルタ
- `licenseType` (任意): 免許種別でフィルタ
- `status` (任意): ステータスでフィルタ
- `expiringSoon` (任意): 指定日数以内に期限切れの免許でフィルタ

#### レスポンス
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "日本溶接協会",
      "status": "有効",
      "remarks": "新規取得"
    },
    {
      "id": 2,
      "employeeCode": "EMP002",
      "employeeName": "佐藤花子",
      "licenseNumber": "WL2024002",
      "licenseType": "特殊溶接",
      "issueDate": "2023-06-20",
      "expiryDate": "2025-06-20",
      "issuingAuthority": "日本溶接協会",
      "status": "有効",
      "remarks": "更新済み"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 50,
    "totalPages": 3
  }
}
```

### 2. 溶接免許IDで取得
**GET** `/api/v1/welding-licenses/{id}`

#### パスパラメータ
- `id`: 溶接免許ID

#### レスポンス
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "田中太郎",
    "licenseNumber": "WL2024001",
    "licenseType": "一般溶接",
    "issueDate": "2024-01-15",
    "expiryDate": "2026-01-15",
    "issuingAuthority": "日本溶接協会",
    "status": "有効",
    "remarks": "新規取得",
    "renewalHistory": [
      {
        "renewalId": "REN2024001",
        "renewalDate": "2024-01-15",
        "newExpiryDate": "2026-01-15",
        "renewalReason": "新規取得",
        "status": "完了"
      }
    ]
  }
}
```

### 3. 社員の溶接免許取得
**GET** `/api/v1/welding-licenses/employee/{employeeCode}`

#### パスパラメータ
- `employeeCode`: 社員コード

#### クエリパラメータ
- `status` (任意): ステータスでフィルタ
- `activeOnly` (任意): 有効な免許のみ表示 (デフォルト: false)

#### レスポンス
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "日本溶接協会",
      "status": "有効",
      "remarks": "新規取得"
    }
  ]
}
```

### 4. 溶接免許作成
**POST** `/api/v1/welding-licenses`

#### リクエストボディ
```json
{
  "employeeCode": "EMP003",
  "licenseNumber": "WL2024003",
  "licenseType": "一般溶接",
  "issueDate": "2024-01-20",
  "expiryDate": "2026-01-20",
  "issuingAuthority": "日本溶接協会",
  "status": "有効",
  "remarks": "新規免許取得"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "溶接免許が正常に作成されました",
  "data": {
    "id": 3,
    "createdAt": "2024-01-20T10:30:00Z"
  }
}
```

### 5. 溶接免許更新
**PUT** `/api/v1/welding-licenses/{id}`

#### パスパラメータ
- `id`: 溶接免許ID

#### リクエストボディ
```json
{
  "licenseType": "特殊溶接",
  "expiryDate": "2027-01-15",
  "status": "有効",
  "remarks": "免許種別変更"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "溶接免許が正常に更新されました",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-20T11:00:00Z"
  }
}
```

### 6. 溶接免許削除
**DELETE** `/api/v1/welding-licenses/{id}`

#### パスパラメータ
- `id`: 溶接免許ID

#### レスポンス
```json
{
  "success": true,
  "message": "溶接免許が正常に削除されました"
}
```

### 7. 溶接免許更新
**POST** `/api/v1/welding-licenses/{id}/renew`

#### パスパラメータ
- `id`: 溶接免許ID

#### リクエストボディ
```json
{
  "renewalDate": "2024-01-20",
  "newExpiryDate": "2026-01-20",
  "renewalReason": "定期更新",
  "processedBy": "ADMIN001"
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "溶接免許が正常に更新されました",
  "data": {
    "renewalId": "REN2024002",
    "renewalDate": "2024-01-20T10:30:00Z"
  }
}
```

### 8. 免許更新履歴取得
**GET** `/api/v1/welding-licenses/{id}/renewals`

#### パスパラメータ
- `id`: 溶接免許ID

#### レスポンス
```json
{
  "data": [
    {
      "renewalId": "REN2024001",
      "licenseId": 1,
      "renewalDate": "2024-01-15",
      "newExpiryDate": "2026-01-15",
      "renewalReason": "新規取得",
      "status": "完了",
      "processedBy": "ADMIN001",
      "processedAt": "2024-01-15T10:30:00Z",
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ]
}
```

### 9. 期限切れ間近の免許取得
**GET** `/api/v1/welding-licenses/expiring`

#### クエリパラメータ
- `days` (任意): チェックする日数 (デフォルト: 30)
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "expiryDate": "2024-02-15",
      "daysUntilExpiry": 15,
      "status": "有効"
    }
  ],
  "summary": {
    "totalExpiring": 5,
    "criticalExpiring": 2,
    "warningExpiring": 3
  }
}
```

### 10. 免許統計取得
**GET** `/api/v1/welding-licenses/statistics`

#### クエリパラメータ
- `year` (任意): 年 (デフォルト: 当年)
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
```json
{
  "data": {
    "year": 2024,
    "totalLicenses": 100,
    "activeLicenses": 85,
    "expiredLicenses": 10,
    "expiringSoon": 5,
    "licensesByType": [
      {
        "type": "一般溶接",
        "count": 60,
        "percentage": 60.0
      },
      {
        "type": "特殊溶接",
        "count": 40,
        "percentage": 40.0
      }
    ],
    "licensesByStatus": [
      {
        "status": "有効",
        "count": 85,
        "percentage": 85.0
      },
      {
        "status": "期限切れ",
        "count": 10,
        "percentage": 10.0
      },
      {
        "status": "更新中",
        "count": 5,
        "percentage": 5.0
      }
    ],
    "renewalRate": 95.0
  }
}
```

### 11. 溶接免許検索
**GET** `/api/v1/welding-licenses/search`

#### クエリパラメータ
- `keyword` (必須): 検索キーワード
- `licenseType` (任意): 免許種別でフィルタ
- `status` (任意): ステータスでフィルタ

#### レスポンス
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "expiryDate": "2026-01-15",
      "status": "有効"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 25,
    "totalPages": 2
  }
}
```

### 12. 免許検証
**POST** `/api/v1/welding-licenses/validate`

#### リクエストボディ
```json
{
  "licenseNumber": "WL2024001",
  "employeeCode": "EMP001"
}
```

#### レスポンス
```json
{
  "valid": true,
  "license": {
    "id": 1,
    "licenseNumber": "WL2024001",
    "licenseType": "一般溶接",
    "expiryDate": "2026-01-15",
    "status": "有効"
  },
  "message": "免許は有効です"
}
```

### 13. 免許一括インポート
**POST** `/api/v1/welding-licenses/import`

#### リクエストボディ
```json
{
  "licenses": [
    {
      "employeeCode": "EMP001",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "日本溶接協会",
      "status": "有効"
    },
    {
      "employeeCode": "EMP002",
      "licenseNumber": "WL2024002",
      "licenseType": "特殊溶接",
      "issueDate": "2024-01-20",
      "expiryDate": "2026-01-20",
      "issuingAuthority": "日本溶接協会",
      "status": "有効"
    }
  ]
}
```

#### レスポンス
```json
{
  "success": true,
  "message": "免許が正常にインポートされました",
  "data": {
    "importedCount": 2,
    "failedCount": 0,
    "errors": []
  }
}
```

### 14. 免許データエクスポート
**GET** `/api/v1/welding-licenses/export`

#### クエリパラメータ
- `format` (任意): エクスポート形式 (csv, excel) (デフォルト: excel)
- `status` (任意): ステータスでフィルタ
- `departmentId` (任意): 部署でフィルタ

#### レスポンス
指定された形式で免許データのファイルダウンロード

## エラーレスポンス

### 400 Bad Request
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "入力データが無効です",
  "details": [
    {
      "field": "licenseNumber",
      "message": "免許番号は必須です"
    }
  ]
}
```

### 404 Not Found
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "溶接免許が見つかりません"
}
```

### 409 Conflict
```json
{
  "success": false,
  "error": "CONFLICT",
  "message": "免許番号は既に存在します"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "INTERNAL_ERROR",
  "message": "予期しないエラーが発生しました"
}
```

## ビジネスルール

1. **免許番号**: すべての免許で一意である必要があります
2. **有効期限**: 交付日より後である必要があります
3. **更新**: 有効な免許のみ更新可能
4. **ステータス**: 有効なステータス: 有効, 期限切れ, 更新中, 無効
5. **社員**: 社員コードは既存の社員を参照する必要があります
6. **交付機関**: 交付機関は有効である必要があります

## データベース制約

- 主キー: `ID`
- 外部キー: `社員コード` → `T_社員マスタ.社員コード`
- 免許番号の一意制約
- 日付検証のチェック制約

## 使用例

### 特定社員の溶接免許取得
```bash
curl -X GET "https://api.company.com/api/v1/welding-licenses/employee/EMP001" \
  -H "Authorization: Bearer your-token"
```

### 新しい溶接免許作成
```bash
curl -X POST "https://api.company.com/api/v1/welding-licenses" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeCode": "EMP003",
    "licenseNumber": "WL2024003",
    "licenseType": "一般溶接",
    "issueDate": "2024-01-20",
    "expiryDate": "2026-01-20",
    "issuingAuthority": "日本溶接協会",
    "status": "有効"
  }'
```

### 期限切れ間近の免許取得
```bash
curl -X GET "https://api.company.com/api/v1/welding-licenses/expiring?days=30" \
  -H "Authorization: Bearer your-token"
```

---

*このAPIドキュメントは社員管理システムの一部です*
