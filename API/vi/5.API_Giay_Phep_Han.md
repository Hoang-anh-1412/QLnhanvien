# 5. API Giấy Phép Hàn

## Tổng quan
API quản lý dữ liệu giấy phép hàn (T_溶接免許). Cung cấp chức năng quản lý giấy phép hàn toàn diện bao gồm đăng ký giấy phép, xác thực và theo dõi.

## Base URL
`/api/v1/welding-licenses`

## Xác thực
Bearer Token bắt buộc cho tất cả các endpoint

## Mô hình dữ liệu

### Thực thể Giấy Phép Hàn
```json
{
  "id": "number",                     // ID (Khóa chính)
  "employeeCode": "string",           // Mã nhân viên (Khóa ngoại)
  "licenseNumber": "string",          // Số giấy phép
  "licenseType": "string",            // Loại giấy phép
  "issueDate": "date",                // Ngày cấp
  "expiryDate": "date",               // Ngày hết hạn
  "issuingAuthority": "string",       // Cơ quan cấp
  "status": "string",                 // Trạng thái
  "remarks": "string"                 // Ghi chú
}
```

### Thực thể Gia Hạn Giấy Phép
```json
{
  "renewalId": "string",              // ID gia hạn
  "licenseId": "number",              // ID giấy phép
  "renewalDate": "date",              // Ngày gia hạn
  "newExpiryDate": "date",            // Ngày hết hạn mới
  "renewalReason": "string",          // Lý do gia hạn
  "status": "string",                 // Trạng thái
  "processedBy": "string",            // Người xử lý
  "processedAt": "datetime",          // Thời gian xử lý
  "createdAt": "datetime"             // Thời gian tạo
}
```

## Endpoints

### 1. Lấy tất cả Giấy Phép Hàn
**GET** `/api/v1/welding-licenses`

#### Tham số truy vấn
- `page` (tùy chọn): Số trang (mặc định: 1)
- `size` (tùy chọn): Kích thước trang (mặc định: 20)
- `employeeCode` (tùy chọn): Lọc theo mã nhân viên
- `licenseType` (tùy chọn): Lọc theo loại giấy phép
- `status` (tùy chọn): Lọc theo trạng thái
- `expiringSoon` (tùy chọn): Lọc theo giấy phép sắp hết hạn trong số ngày

#### Phản hồi
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "Nguyễn Văn A",
      "licenseNumber": "WL2024001",
      "licenseType": "Hàn thông thường",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
      "status": "Có hiệu lực",
      "remarks": "Cấp mới"
    },
    {
      "id": 2,
      "employeeCode": "EMP002",
      "employeeName": "Trần Thị B",
      "licenseNumber": "WL2024002",
      "licenseType": "Hàn đặc biệt",
      "issueDate": "2023-06-20",
      "expiryDate": "2025-06-20",
      "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
      "status": "Có hiệu lực",
      "remarks": "Đã gia hạn"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 50,
    "totalPages": 3
  }
}
```

### 2. Lấy Giấy Phép Hàn theo ID
**GET** `/api/v1/welding-licenses/{id}`

#### Tham số đường dẫn
- `id`: ID giấy phép hàn

#### Phản hồi
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "Nguyễn Văn A",
    "licenseNumber": "WL2024001",
    "licenseType": "Hàn thông thường",
    "issueDate": "2024-01-15",
    "expiryDate": "2026-01-15",
    "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
    "status": "Có hiệu lực",
    "remarks": "Cấp mới",
    "renewalHistory": [
      {
        "renewalId": "REN2024001",
        "renewalDate": "2024-01-15",
        "newExpiryDate": "2026-01-15",
        "renewalReason": "Cấp mới",
        "status": "Hoàn thành"
      }
    ]
  }
}
```

### 3. Lấy Giấy Phép Hàn theo Nhân viên
**GET** `/api/v1/welding-licenses/employee/{employeeCode}`

#### Tham số đường dẫn
- `employeeCode`: Mã nhân viên

#### Tham số truy vấn
- `status` (tùy chọn): Lọc theo trạng thái
- `activeOnly` (tùy chọn): Chỉ hiển thị giấy phép có hiệu lực (mặc định: false)

#### Phản hồi
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "licenseNumber": "WL2024001",
      "licenseType": "Hàn thông thường",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
      "status": "Có hiệu lực",
      "remarks": "Cấp mới"
    }
  ]
}
```

### 4. Tạo Giấy Phép Hàn
**POST** `/api/v1/welding-licenses`

#### Nội dung yêu cầu
```json
{
  "employeeCode": "EMP003",
  "licenseNumber": "WL2024003",
  "licenseType": "Hàn thông thường",
  "issueDate": "2024-01-20",
  "expiryDate": "2026-01-20",
  "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
  "status": "Có hiệu lực",
  "remarks": "Cấp giấy phép mới"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Giấy phép hàn đã được tạo thành công",
  "data": {
    "id": 3,
    "createdAt": "2024-01-20T10:30:00Z"
  }
}
```

### 5. Cập nhật Giấy Phép Hàn
**PUT** `/api/v1/welding-licenses/{id}`

#### Tham số đường dẫn
- `id`: ID giấy phép hàn

#### Nội dung yêu cầu
```json
{
  "licenseType": "Hàn đặc biệt",
  "expiryDate": "2027-01-15",
  "status": "Có hiệu lực",
  "remarks": "Thay đổi loại giấy phép"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Giấy phép hàn đã được cập nhật thành công",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-20T11:00:00Z"
  }
}
```

### 6. Xóa Giấy Phép Hàn
**DELETE** `/api/v1/welding-licenses/{id}`

#### Tham số đường dẫn
- `id`: ID giấy phép hàn

#### Phản hồi
```json
{
  "success": true,
  "message": "Giấy phép hàn đã được xóa thành công"
}
```

### 7. Gia hạn Giấy Phép Hàn
**POST** `/api/v1/welding-licenses/{id}/renew`

#### Tham số đường dẫn
- `id`: ID giấy phép hàn

#### Nội dung yêu cầu
```json
{
  "renewalDate": "2024-01-20",
  "newExpiryDate": "2026-01-20",
  "renewalReason": "Gia hạn định kỳ",
  "processedBy": "ADMIN001"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Giấy phép hàn đã được gia hạn thành công",
  "data": {
    "renewalId": "REN2024002",
    "renewalDate": "2024-01-20T10:30:00Z"
  }
}
```

### 8. Lấy Lịch sử Gia hạn
**GET** `/api/v1/welding-licenses/{id}/renewals`

#### Tham số đường dẫn
- `id`: ID giấy phép hàn

#### Phản hồi
```json
{
  "data": [
    {
      "renewalId": "REN2024001",
      "licenseId": 1,
      "renewalDate": "2024-01-15",
      "newExpiryDate": "2026-01-15",
      "renewalReason": "Cấp mới",
      "status": "Hoàn thành",
      "processedBy": "ADMIN001",
      "processedAt": "2024-01-15T10:30:00Z",
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ]
}
```

### 9. Lấy Giấy Phép Sắp Hết hạn
**GET** `/api/v1/welding-licenses/expiring`

#### Tham số truy vấn
- `days` (tùy chọn): Số ngày kiểm tra trước (mặc định: 30)
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "Nguyễn Văn A",
      "licenseNumber": "WL2024001",
      "licenseType": "Hàn thông thường",
      "expiryDate": "2024-02-15",
      "daysUntilExpiry": 15,
      "status": "Có hiệu lực"
    }
  ],
  "summary": {
    "totalExpiring": 5,
    "criticalExpiring": 2,
    "warningExpiring": 3
  }
}
```

### 10. Lấy Thống kê Giấy Phép
**GET** `/api/v1/welding-licenses/statistics`

#### Tham số truy vấn
- `year` (tùy chọn): Năm (mặc định: năm hiện tại)
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
```json
{
  "data": {
    "year": 2024,
    "totalLicenses": 100,
    "activeLicenses": 85,
    "expiredLicenses": 10,
    "expiringSoon": 5,
    "licensesByType": [
      {
        "type": "Hàn thông thường",
        "count": 60,
        "percentage": 60.0
      },
      {
        "type": "Hàn đặc biệt",
        "count": 40,
        "percentage": 40.0
      }
    ],
    "licensesByStatus": [
      {
        "status": "Có hiệu lực",
        "count": 85,
        "percentage": 85.0
      },
      {
        "status": "Hết hạn",
        "count": 10,
        "percentage": 10.0
      },
      {
        "status": "Đang gia hạn",
        "count": 5,
        "percentage": 5.0
      }
    ],
    "renewalRate": 95.0
  }
}
```

### 11. Tìm kiếm Giấy Phép Hàn
**GET** `/api/v1/welding-licenses/search`

#### Tham số truy vấn
- `keyword` (bắt buộc): Từ khóa tìm kiếm
- `licenseType` (tùy chọn): Lọc theo loại giấy phép
- `status` (tùy chọn): Lọc theo trạng thái

#### Phản hồi
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "Nguyễn Văn A",
      "licenseNumber": "WL2024001",
      "licenseType": "Hàn thông thường",
      "expiryDate": "2026-01-15",
      "status": "Có hiệu lực"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 25,
    "totalPages": 2
  }
}
```

### 12. Xác thực Giấy Phép
**POST** `/api/v1/welding-licenses/validate`

#### Nội dung yêu cầu
```json
{
  "licenseNumber": "WL2024001",
  "employeeCode": "EMP001"
}
```

#### Phản hồi
```json
{
  "valid": true,
  "license": {
    "id": 1,
    "licenseNumber": "WL2024001",
    "licenseType": "Hàn thông thường",
    "expiryDate": "2026-01-15",
    "status": "Có hiệu lực"
  },
  "message": "Giấy phép có hiệu lực"
}
```

### 13. Nhập hàng loạt Giấy Phép
**POST** `/api/v1/welding-licenses/import`

#### Nội dung yêu cầu
```json
{
  "licenses": [
    {
      "employeeCode": "EMP001",
      "licenseNumber": "WL2024001",
      "licenseType": "Hàn thông thường",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
      "status": "Có hiệu lực"
    },
    {
      "employeeCode": "EMP002",
      "licenseNumber": "WL2024002",
      "licenseType": "Hàn đặc biệt",
      "issueDate": "2024-01-20",
      "expiryDate": "2026-01-20",
      "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
      "status": "Có hiệu lực"
    }
  ]
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Giấy phép đã được nhập thành công",
  "data": {
    "importedCount": 2,
    "failedCount": 0,
    "errors": []
  }
}
```

### 14. Xuất Dữ liệu Giấy Phép
**GET** `/api/v1/welding-licenses/export`

#### Tham số truy vấn
- `format` (tùy chọn): Định dạng xuất (csv, excel) (mặc định: excel)
- `status` (tùy chọn): Lọc theo trạng thái
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
Tải xuống file với dữ liệu giấy phép theo định dạng đã chỉ định

## Phản hồi lỗi

### 400 Bad Request
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "Dữ liệu đầu vào không hợp lệ",
  "details": [
    {
      "field": "licenseNumber",
      "message": "Số giấy phép là bắt buộc"
    }
  ]
}
```

### 404 Not Found
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "Không tìm thấy giấy phép hàn"
}
```

### 409 Conflict
```json
{
  "success": false,
  "error": "CONFLICT",
  "message": "Số giấy phép đã tồn tại"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "INTERNAL_ERROR",
  "message": "Đã xảy ra lỗi không mong muốn"
}
```

## Quy tắc nghiệp vụ

1. **Số Giấy Phép**: Phải duy nhất trong tất cả các giấy phép
2. **Ngày Hết hạn**: Phải sau ngày cấp
3. **Gia hạn**: Chỉ có thể gia hạn giấy phép có hiệu lực
4. **Trạng thái**: Các trạng thái hợp lệ: Có hiệu lực, Hết hạn, Đang gia hạn, Vô hiệu
5. **Nhân viên**: Mã nhân viên phải tham chiếu đến nhân viên hiện có
6. **Cơ quan Cấp**: Cơ quan cấp phải hợp lệ

## Ràng buộc cơ sở dữ liệu

- Khóa chính: `ID`
- Khóa ngoại: `社員コード` → `T_社員マスタ.社員コード`
- Ràng buộc duy nhất cho số giấy phép
- Ràng buộc kiểm tra cho xác thực ngày

## Ví dụ sử dụng

### Lấy giấy phép hàn của nhân viên cụ thể
```bash
curl -X GET "https://api.company.com/api/v1/welding-licenses/employee/EMP001" \
  -H "Authorization: Bearer your-token"
```

### Tạo giấy phép hàn mới
```bash
curl -X POST "https://api.company.com/api/v1/welding-licenses" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeCode": "EMP003",
    "licenseNumber": "WL2024003",
    "licenseType": "Hàn thông thường",
    "issueDate": "2024-01-20",
    "expiryDate": "2026-01-20",
    "issuingAuthority": "Hiệp hội Hàn Nhật Bản",
    "status": "Có hiệu lực"
  }'
```

### Lấy giấy phép sắp hết hạn
```bash
curl -X GET "https://api.company.com/api/v1/welding-licenses/expiring?days=30" \
  -H "Authorization: Bearer your-token"
```

---

*Tài liệu API này là một phần của Hệ thống Quản lý Nhân viên*
