# 8. API Đơn Đặt Hàng Đồng Phục (作業服注文)

**Phiên bản:** v0.1  
**Ngày cập nhật:** 2025-10-25  
**Tác giả:** Chính  
**Người kiểm duyệt:** [PM/Leader Name]  
**Hệ thống:** Quản lý Nhân sự  

---

## 1. Tổng quan
API quản lý đơn đặt hàng đồng phục của nhân viên (作業服注文) - quản lý toàn bộ quy trình đặt hàng, xác nhận và giao hàng đồng phục.

**Database Table:** `T_作業服注文` (cần tạo mới)

---

## 2. Endpoints

### 2.1. Lấy danh sách đơn đặt hàng đồng phục
- **API Call:** `GET /api/v1/work-uniform-orders`
- **Mô tả:** Lấy danh sách tất cả đơn đặt hàng đồng phục
- **Query Parameters:**
  - `page` (number, optional): Số trang (mặc định: 1)
  - `size` (number, optional): Kích thước trang (mặc định: 20, tối đa: 100)
  - `divisionName` (string, optional): Lọc theo tên phòng ban giám sát
  - `departmentName` (string, optional): Lọc theo tên phòng ban
  - `employeeName` (string, optional): Lọc theo tên nhân viên
  - `orderDateFrom` (string, optional): Lọc từ ngày đặt hàng (YYYY-MM-DD)
  - `orderDateTo` (string, optional): Lọc đến ngày đặt hàng (YYYY-MM-DD)
  - `status` (string, optional): Lọc theo trạng thái
  - `sort` (string, optional): Sắp xếp (mặc định: orderDate,desc)

**Response Data Type:**
```typescript
interface WorkUniformOrder {
  orderCode: string;
  employeeCode: string;
  employeeName: string;
  divisionName: string;
  departmentName: string;
  orderDate: string;
  deliveryDate?: string;
  status: 'pending' | 'confirmed' | 'delivered' | 'cancelled';
  totalAmount: number;
  items: WorkUniformItem[];
  remarks?: string;
  createdAt: string;
  updatedAt: string;
}

interface WorkUniformItem {
  itemCode: string;
  itemName: string;
  size: string;
  color: string;
  quantity: number;
  unitPrice: number;
  totalPrice: number;
}

interface WorkUniformOrderListResponse {
  success: true;
  data: WorkUniformOrder[];
  message: "Lấy danh sách đơn đặt hàng đồng phục thành công";
  pagination: {
    page: number;
    size: number;
    totalElements: number;
    totalPages: number;
    hasNext: boolean;
    hasPrevious: boolean;
  };
}
```

**Example Response:**
```json
{
  "success": true,
  "data": [
    {
      "orderCode": "WO2025001",
      "employeeCode": "000893",
      "employeeName": "佐藤 悠",
      "divisionName": "東日本支店",
      "departmentName": "AA一課",
      "orderDate": "2025-04-14",
      "deliveryDate": "2025-04-21",
      "status": "pending",
      "totalAmount": 150000,
      "items": [
        {
          "itemCode": "UF001",
          "itemName": "作業服 上下セット",
          "size": "M",
          "color": "ネイビー",
          "quantity": 2,
          "unitPrice": 75000,
          "totalPrice": 150000
        }
      ],
      "remarks": "緊急対応",
      "createdAt": "2025-04-14T10:30:00Z",
      "updatedAt": "2025-04-14T10:30:00Z"
    }
  ],
  "message": "Lấy danh sách đơn đặt hàng đồng phục thành công",
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 5989,
    "totalPages": 300,
    "hasNext": true,
    "hasPrevious": false
  }
}
```

### 2.2. Lấy thông tin đơn đặt hàng theo mã
- **API Call:** `GET /api/v1/work-uniform-orders/{orderCode}`
- **Mô tả:** Lấy thông tin chi tiết một đơn đặt hàng
- **Path Parameters:**
  - `orderCode` (string, required): Mã đơn đặt hàng

**Response Data Type:**
```typescript
interface WorkUniformOrderDetailResponse {
  success: true;
  data: WorkUniformOrder;
  message: "Lấy thông tin đơn đặt hàng thành công";
}
```

### 2.3. Tạo đơn đặt hàng mới
- **API Call:** `POST /api/v1/work-uniform-orders`
- **Mô tả:** Tạo đơn đặt hàng đồng phục mới
- **Request Data Type:**
```typescript
interface CreateWorkUniformOrderRequest {
  employeeCode: string;
  orderDate: string;
  deliveryDate?: string;
  items: {
    itemCode: string;
    size: string;
    color: string;
    quantity: number;
  }[];
  remarks?: string;
}
```

**Response Data Type:**
```typescript
interface CreateWorkUniformOrderResponse {
  success: true;
  data: WorkUniformOrder;
  message: "Tạo đơn đặt hàng thành công";
}
```

### 2.4. Cập nhật đơn đặt hàng
- **API Call:** `PUT /api/v1/work-uniform-orders/{orderCode}`
- **Mô tả:** Cập nhật thông tin đơn đặt hàng
- **Path Parameters:**
  - `orderCode` (string, required): Mã đơn đặt hàng
- **Request Data Type:**
```typescript
interface UpdateWorkUniformOrderRequest {
  deliveryDate?: string;
  status: 'pending' | 'confirmed' | 'delivered' | 'cancelled';
  items: {
    itemCode: string;
    size: string;
    color: string;
    quantity: number;
  }[];
  remarks?: string;
}
```

**Response Data Type:**
```typescript
interface UpdateWorkUniformOrderResponse {
  success: true;
  data: WorkUniformOrder;
  message: "Cập nhật đơn đặt hàng thành công";
}
```

### 2.5. Xóa đơn đặt hàng
- **API Call:** `DELETE /api/v1/work-uniform-orders/{orderCode}`
- **Mô tả:** Xóa đơn đặt hàng (soft delete)
- **Path Parameters:**
  - `orderCode` (string, required): Mã đơn đặt hàng

**Response Data Type:**
```typescript
interface DeleteWorkUniformOrderResponse {
  success: true;
  data: null;
  message: "Xóa đơn đặt hàng thành công";
}
```

### 2.6. Cập nhật trạng thái đơn hàng
- **API Call:** `PATCH /api/v1/work-uniform-orders/{orderCode}/status`
- **Mô tả:** Cập nhật trạng thái đơn hàng
- **Path Parameters:**
  - `orderCode` (string, required): Mã đơn đặt hàng
- **Request Data Type:**
```typescript
interface UpdateOrderStatusRequest {
  status: 'pending' | 'confirmed' | 'delivered' | 'cancelled';
  remarks?: string;
}
```

---

## 3. Error Responses

### 3.1. Validation Error
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "code": "WUO_001",
  "message": "Dữ liệu đầu vào không hợp lệ",
  "details": [
    {
      "field": "employeeCode",
      "message": "Mã nhân viên là bắt buộc",
      "code": "FIELD_REQUIRED"
    },
    {
      "field": "items",
      "message": "Danh sách sản phẩm không được trống",
      "code": "INVALID_ITEMS"
    }
  ]
}
```

### 3.2. Not Found Error
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "code": "WUO_002",
  "message": "Không tìm thấy đơn đặt hàng",
  "details": []
}
```

### 3.3. Conflict Error
```json
{
  "success": false,
  "error": "CONFLICT",
  "code": "WUO_003",
  "message": "Mã đơn hàng đã tồn tại",
  "details": []
}
```

---

## 4. Business Rules

### 4.1. Validation Rules
- **employeeCode:** Bắt buộc, phải tồn tại trong hệ thống
- **orderDate:** Bắt buộc, không được trong tương lai quá 30 ngày
- **deliveryDate:** Tùy chọn, phải sau orderDate
- **items:** Bắt buộc, ít nhất 1 sản phẩm
- **status:** Chỉ cho phép các giá trị định sẵn

### 4.2. Constraints
- Không thể xóa đơn hàng đã giao (status = 'delivered')
- Không thể sửa đơn hàng đã hủy (status = 'cancelled')
- Tự động tính tổng tiền dựa trên items

### 4.3. Permissions
- **hr:read:** Xem danh sách và chi tiết đơn hàng
- **hr:write:** Tạo, cập nhật đơn hàng
- **hr:admin:** Xóa đơn hàng, cập nhật trạng thái

---

## 5. Database Schema

### 5.1. Table Structure
```sql
CREATE TABLE T_作業服注文 (
    注文コード VARCHAR2(50 CHAR) PRIMARY KEY,
    社員コード VARCHAR2(50 CHAR),
    注文日 DATE,
    納入日 DATE,
    ステータス VARCHAR2(20 CHAR),
    合計金額 NUMBER(12, 2),
    備考 VARCHAR2(255 CHAR),
    作成日時 TIMESTAMP,
    更新日時 TIMESTAMP,
    CONSTRAINT FK_作業服注文_社員 FOREIGN KEY (社員コード) REFERENCES T_社員マスタ(社員コード)
);

CREATE TABLE T_作業服注文明細 (
    ID NUMBER(10) PRIMARY KEY,
    注文コード VARCHAR2(50 CHAR),
    商品コード VARCHAR2(50 CHAR),
    サイズ VARCHAR2(20 CHAR),
    色 VARCHAR2(20 CHAR),
    数量 NUMBER(5),
    単価 NUMBER(10, 2),
    小計 NUMBER(12, 2),
    CONSTRAINT FK_注文明細_注文 FOREIGN KEY (注文コード) REFERENCES T_作業服注文(注文コード)
);
```

### 5.2. Indexes
- `IDX_作業服注文_社員コード` on `T_作業服注文(社員コード)`
- `IDX_作業服注文_注文日` on `T_作業服注文(注文日)`
- `IDX_作業服注文_ステータス` on `T_作業服注文(ステータス)`

---

## 6. Performance Considerations

### 6.1. Caching
- Cache danh sách đơn hàng trong 5 phút
- Invalidate cache khi có thay đổi

### 6.2. Pagination
- Mặc định 20 items per page
- Tối đa 100 items per page
- Sử dụng OFFSET/LIMIT cho Oracle

---

## 7. Testing Scenarios

### 7.1. Happy Path
1. Lấy danh sách đơn hàng thành công
2. Tạo đơn hàng mới thành công
3. Cập nhật đơn hàng thành công
4. Cập nhật trạng thái đơn hàng thành công

### 7.2. Error Cases
1. Tạo đơn hàng với mã nhân viên không tồn tại
2. Cập nhật đơn hàng không tồn tại
3. Xóa đơn hàng đã giao
4. Validation lỗi khi thiếu thông tin bắt buộc

---

*API này tuân thủ các quy tắc RESTful và tiêu chuẩn trong README.md*
