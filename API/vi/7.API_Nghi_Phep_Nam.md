# 4. API Nghỉ Phép Năm

## Tổng quan
API quản lý dữ liệu nghỉ phép năm (T_年休詳細). Cung cấp chức năng quản lý nghỉ phép năm toàn diện bao gồm đơn xin nghỉ, phê duyệt và theo dõi.

## Base URL
`/api/v1/annual-leaves`

## Xác thực
Bearer Token bắt buộc cho tất cả các endpoint

## Mô hình dữ liệu

### Thực thể Nghỉ Phép Năm
```json
{
  "id": "number",                     // ID (Khóa chính)
  "employeeCode": "string",           // Mã nhân viên (Khóa ngoại)
  "leaveYear": "number",              // Năm nghỉ phép
  "totalDays": "number",              // Số ngày nghỉ phép
  "usedDays": "number",               // Số ngày đã sử dụng
  "remainingDays": "number",          // Số ngày còn lại
  "carryOverDays": "number",          // Số ngày chuyển sang năm sau
  "grantedDays": "number",            // Số ngày được cấp
  "expiredDays": "number",            // Số ngày hết hạn
  "remarks": "string"                 // Ghi chú
}
```

### Thực thể Đơn Xin Nghỉ
```json
{
  "requestId": "string",              // ID đơn xin
  "employeeCode": "string",           // Mã nhân viên
  "leaveType": "string",              // Loại nghỉ phép
  "startDate": "date",                // Ngày bắt đầu
  "endDate": "date",                  // Ngày kết thúc
  "days": "number",                   // Số ngày
  "reason": "string",                 // Lý do
  "status": "string",                 // Trạng thái
  "approverCode": "string",           // Mã người phê duyệt
  "approvedAt": "datetime",           // Thời gian phê duyệt
  "createdAt": "datetime",            // Thời gian tạo
  "updatedAt": "datetime"             // Thời gian cập nhật
}
```

## Endpoints

### 1. Lấy tất cả Nghỉ Phép Năm
**GET** `/api/v1/annual-leaves`

#### Tham số truy vấn
- `page` (tùy chọn): Số trang (mặc định: 1)
- `size` (tùy chọn): Kích thước trang (mặc định: 20)
- `employeeCode` (tùy chọn): Lọc theo mã nhân viên
- `year` (tùy chọn): Lọc theo năm nghỉ phép
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "Nguyễn Văn A",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 5,
      "remainingDays": 15,
      "carryOverDays": 2,
      "grantedDays": 18,
      "expiredDays": 0,
      "remarks": "Nhân viên mới"
    },
    {
      "id": 2,
      "employeeCode": "EMP002",
      "employeeName": "Trần Thị B",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 12,
      "remainingDays": 8,
      "carryOverDays": 0,
      "grantedDays": 20,
      "expiredDays": 0,
      "remarks": "Nhân viên kỳ cựu"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

### 2. Lấy Nghỉ Phép Năm theo ID
**GET** `/api/v1/annual-leaves/{id}`

#### Tham số đường dẫn
- `id`: ID nghỉ phép năm

#### Phản hồi
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "Nguyễn Văn A",
    "leaveYear": 2024,
    "totalDays": 20,
    "usedDays": 5,
    "remainingDays": 15,
    "carryOverDays": 2,
    "grantedDays": 18,
    "expiredDays": 0,
    "remarks": "Nhân viên mới"
  }
}
```

### 3. Lấy Nghỉ Phép Năm theo Nhân viên
**GET** `/api/v1/annual-leaves/employee/{employeeCode}`

#### Tham số đường dẫn
- `employeeCode`: Mã nhân viên

#### Tham số truy vấn
- `year` (tùy chọn): Năm nghỉ phép (mặc định: năm hiện tại)

#### Phản hồi
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "Nguyễn Văn A",
    "leaveYear": 2024,
    "totalDays": 20,
    "usedDays": 5,
    "remainingDays": 15,
    "carryOverDays": 2,
    "grantedDays": 18,
    "expiredDays": 0,
    "remarks": "Nhân viên mới",
    "leaveHistory": [
      {
        "date": "2024-03-15",
        "days": 1,
        "type": "Nghỉ phép có lương",
        "status": "Đã phê duyệt"
      },
      {
        "date": "2024-04-20",
        "days": 2,
        "type": "Nghỉ phép có lương",
        "status": "Đã phê duyệt"
      }
    ]
  }
}
```

### 4. Tạo Nghỉ Phép Năm
**POST** `/api/v1/annual-leaves`

#### Nội dung yêu cầu
```json
{
  "employeeCode": "EMP003",
  "leaveYear": 2024,
  "totalDays": 20,
  "usedDays": 0,
  "remainingDays": 20,
  "carryOverDays": 0,
  "grantedDays": 20,
  "expiredDays": 0,
  "remarks": "Thiết lập nghỉ phép cho nhân viên mới"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Nghỉ phép năm đã được tạo thành công",
  "data": {
    "id": 3,
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 5. Cập nhật Nghỉ Phép Năm
**PUT** `/api/v1/annual-leaves/{id}`

#### Tham số đường dẫn
- `id`: ID nghỉ phép năm

#### Nội dung yêu cầu
```json
{
  "totalDays": 22,
  "usedDays": 3,
  "remainingDays": 19,
  "carryOverDays": 2,
  "grantedDays": 20,
  "expiredDays": 0,
  "remarks": "Cập nhật số ngày nghỉ phép"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Nghỉ phép năm đã được cập nhật thành công",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-15T11:00:00Z"
  }
}
```

### 6. Xóa Nghỉ Phép Năm
**DELETE** `/api/v1/annual-leaves/{id}`

#### Tham số đường dẫn
- `id`: ID nghỉ phép năm

#### Phản hồi
```json
{
  "success": true,
  "message": "Nghỉ phép năm đã được xóa thành công"
}
```

### 7. Đăng ký Nghỉ Phép
**POST** `/api/v1/annual-leaves/request`

#### Nội dung yêu cầu
```json
{
  "employeeCode": "EMP001",
  "leaveType": "Nghỉ phép có lương",
  "startDate": "2024-05-15",
  "endDate": "2024-05-17",
  "days": 3,
  "reason": "Du lịch gia đình"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Đơn xin nghỉ phép đã được gửi thành công",
  "data": {
    "requestId": "REQ2024001",
    "status": "Đang chờ phê duyệt",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 8. Phê duyệt/Từ chối Đơn Xin Nghỉ
**PUT** `/api/v1/annual-leaves/request/{requestId}/status`

#### Tham số đường dẫn
- `requestId`: ID đơn xin nghỉ phép

#### Nội dung yêu cầu
```json
{
  "status": "Đã phê duyệt",
  "approverCode": "MGR001",
  "comments": "Tôi phê duyệt"
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Trạng thái đơn xin nghỉ phép đã được cập nhật thành công",
  "data": {
    "requestId": "REQ2024001",
    "status": "Đã phê duyệt",
    "approvedAt": "2024-01-15T11:00:00Z"
  }
}
```

### 9. Lấy Danh sách Đơn Xin Nghỉ
**GET** `/api/v1/annual-leaves/requests`

#### Tham số truy vấn
- `page` (tùy chọn): Số trang (mặc định: 1)
- `size` (tùy chọn): Kích thước trang (mặc định: 20)
- `employeeCode` (tùy chọn): Lọc theo nhân viên
- `status` (tùy chọn): Lọc theo trạng thái
- `startDate` (tùy chọn): Lọc theo ngày bắt đầu
- `endDate` (tùy chọn): Lọc theo ngày kết thúc

#### Phản hồi
```json
{
  "data": [
    {
      "requestId": "REQ2024001",
      "employeeCode": "EMP001",
      "employeeName": "Nguyễn Văn A",
      "leaveType": "Nghỉ phép có lương",
      "startDate": "2024-05-15",
      "endDate": "2024-05-17",
      "days": 3,
      "reason": "Du lịch gia đình",
      "status": "Đã phê duyệt",
      "approverCode": "MGR001",
      "approvedAt": "2024-01-15T11:00:00Z",
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 50,
    "totalPages": 3
  }
}
```

### 10. Lấy Thống kê Nghỉ Phép
**GET** `/api/v1/annual-leaves/statistics`

#### Tham số truy vấn
- `year` (tùy chọn): Năm nghỉ phép (mặc định: năm hiện tại)
- `departmentId` (tùy chọn): Lọc theo phòng ban
- `divisionId` (tùy chọn): Lọc theo bộ phận

#### Phản hồi
```json
{
  "data": {
    "year": 2024,
    "totalEmployees": 100,
    "totalLeaveDays": 2000,
    "usedLeaveDays": 1200,
    "remainingLeaveDays": 800,
    "averageUsageRate": 60.0,
    "leaveByMonth": [
      {
        "month": "Tháng 1",
        "usedDays": 150,
        "percentage": 12.5
      },
      {
        "month": "Tháng 2",
        "usedDays": 120,
        "percentage": 10.0
      }
    ],
    "leaveByDepartment": [
      {
        "departmentName": "Phòng Kinh doanh",
        "totalDays": 400,
        "usedDays": 250,
        "usageRate": 62.5
      },
      {
        "departmentName": "Phòng Phát triển",
        "totalDays": 300,
        "usedDays": 180,
        "usageRate": 60.0
      }
    ]
  }
}
```

### 11. Tìm kiếm Nghỉ Phép Năm
**GET** `/api/v1/annual-leaves/search`

#### Tham số truy vấn
- `keyword` (bắt buộc): Từ khóa tìm kiếm
- `year` (tùy chọn): Lọc theo năm
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "Nguyễn Văn A",
      "departmentName": "Phòng Kinh doanh",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 5,
      "remainingDays": 15
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 25,
    "totalPages": 2
  }
}
```

### 12. Cập nhật Hàng loạt Nghỉ Phép Năm
**PUT** `/api/v1/annual-leaves/bulk-update`

#### Nội dung yêu cầu
```json
{
  "updates": [
    {
      "id": 1,
      "totalDays": 22,
      "usedDays": 3,
      "remainingDays": 19
    },
    {
      "id": 2,
      "totalDays": 20,
      "usedDays": 8,
      "remainingDays": 12
    }
  ]
}
```

#### Phản hồi
```json
{
  "success": true,
  "message": "Nghỉ phép năm đã được cập nhật thành công",
  "data": {
    "updatedCount": 2,
    "failedCount": 0,
    "errors": []
  }
}
```

### 13. Lấy Lịch Nghỉ Phép
**GET** `/api/v1/annual-leaves/calendar`

#### Tham số truy vấn
- `year` (tùy chọn): Năm (mặc định: năm hiện tại)
- `month` (tùy chọn): Tháng (mặc định: tháng hiện tại)
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
```json
{
  "data": {
    "year": 2024,
    "month": 5,
    "calendar": [
      {
        "date": "2024-05-01",
        "isHoliday": true,
        "leaveRequests": [
          {
            "employeeCode": "EMP001",
            "employeeName": "Nguyễn Văn A",
            "leaveType": "Nghỉ phép có lương",
            "status": "Đã phê duyệt"
          }
        ]
      },
      {
        "date": "2024-05-02",
        "isHoliday": false,
        "leaveRequests": []
      }
    ]
  }
}
```

### 14. Xuất Dữ liệu Nghỉ Phép
**GET** `/api/v1/annual-leaves/export`

#### Tham số truy vấn
- `format` (tùy chọn): Định dạng xuất (csv, excel) (mặc định: excel)
- `year` (tùy chọn): Năm nghỉ phép
- `departmentId` (tùy chọn): Lọc theo phòng ban

#### Phản hồi
Tải xuống file với dữ liệu nghỉ phép theo định dạng đã chỉ định

## Phản hồi lỗi

### 400 Bad Request
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "Dữ liệu đầu vào không hợp lệ",
  "details": [
    {
      "field": "totalDays",
      "message": "Số ngày nghỉ phép phải là số dương"
    }
  ]
}
```

### 404 Not Found
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "Không tìm thấy bản ghi nghỉ phép năm"
}
```

### 409 Conflict
```json
{
  "success": false,
  "error": "CONFLICT",
  "message": "Đơn xin nghỉ phép xung đột với nghỉ phép hiện có"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "INTERNAL_ERROR",
  "message": "Đã xảy ra lỗi không mong muốn"
}
```

## Quy tắc nghiệp vụ

1. **Tính toán Nghỉ Phép**: Số ngày còn lại = Số ngày nghỉ phép - Số ngày đã sử dụng
2. **Chuyển sang năm sau**: Tối đa 5 ngày có thể chuyển sang năm sau
3. **Đăng ký Nghỉ Phép**: Phải đăng ký ít nhất 1 ngày trước
4. **Phê duyệt**: Chỉ quản lý mới có thể phê duyệt đơn xin nghỉ phép
5. **Hết hạn**: Nghỉ phép chưa sử dụng hết hạn vào cuối năm (trừ phần chuyển sang năm sau)
6. **Ngày liên tiếp**: Tối đa 5 ngày liên tiếp mà không cần phê duyệt đặc biệt

## Ràng buộc cơ sở dữ liệu

- Khóa chính: `ID`
- Khóa ngoại: `社員コード` → `T_社員マスタ.社員コード`
- Ràng buộc kiểm tra cho các giá trị dương
- Ràng buộc duy nhất cho tổ hợp mã nhân viên và năm

## Ví dụ sử dụng

### Lấy nghỉ phép năm của nhân viên cụ thể
```bash
curl -X GET "https://api.company.com/api/v1/annual-leaves/employee/EMP001?year=2024" \
  -H "Authorization: Bearer your-token"
```

### Đăng ký nghỉ phép
```bash
curl -X POST "https://api.company.com/api/v1/annual-leaves/request" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeCode": "EMP001",
    "leaveType": "Nghỉ phép có lương",
    "startDate": "2024-05-15",
    "endDate": "2024-05-17",
    "days": 3,
    "reason": "Du lịch gia đình"
  }'
```

### Lấy thống kê nghỉ phép
```bash
curl -X GET "https://api.company.com/api/v1/annual-leaves/statistics?year=2024" \
  -H "Authorization: Bearer your-token"
```

---

*Tài liệu API này là một phần của Hệ thống Quản lý Nhân viên*
