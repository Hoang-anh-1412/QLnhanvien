# 4. Annual Leave API

## Overview
API for managing annual leave data (T_年休詳細). Provides comprehensive annual leave management functionality including leave requests, approvals, and tracking.

## Base URL
`/api/v1/annual-leaves`

## Authentication
Bearer Token required for all endpoints

## RESTful API Design Principles
- **Resource-based URLs**: Use nouns, not verbs
- **HTTP Methods**: GET, POST, PUT, DELETE, PATCH
- **Status Codes**: Proper HTTP status codes
- **Stateless**: Each request contains all necessary information
- **Cacheable**: GET requests are cacheable
- **Uniform Interface**: Consistent API design across all resources

## Data Models

### Annual Leave Entity
```json
{
  "id": "number",                     // ID (Primary Key)
  "employeeCode": "string",           // 社員コード (Foreign Key)
  "leaveYear": "number",              // 年休年度
  "totalDays": "number",              // 年休日数
  "usedDays": "number",               // 使用日数
  "remainingDays": "number",          // 残日数
  "carryOverDays": "number",          // 繰越日数
  "grantedDays": "number",            // 付与日数
  "expiredDays": "number",            // 失効日数
  "remarks": "string"                 // 備考
}
```

### Leave Request Entity
```json
{
  "requestId": "string",              // 申請ID
  "employeeCode": "string",           // 社員コード
  "leaveType": "string",              // 休暇種別
  "startDate": "date",                // 開始日
  "endDate": "date",                  // 終了日
  "days": "number",                   // 日数
  "reason": "string",                 // 理由
  "status": "string",                 // ステータス
  "approverCode": "string",           // 承認者コード
  "approvedAt": "datetime",           // 承認日時
  "createdAt": "datetime",            // 作成日時
  "updatedAt": "datetime"             // 更新日時
}
```

## Endpoints

### 1. Get All Annual Leaves
**GET** `/api/v1/annual-leaves`

#### Query Parameters
- `page` (optional): Page number (default: 1)
- `size` (optional): Page size (default: 20)
- `employeeCode` (optional): Filter by employee code
- `year` (optional): Filter by leave year
- `departmentId` (optional): Filter by department

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 5,
      "remainingDays": 15,
      "carryOverDays": 2,
      "grantedDays": 18,
      "expiredDays": 0,
      "remarks": "新入社員"
    },
    {
      "id": 2,
      "employeeCode": "EMP002",
      "employeeName": "佐藤花子",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 12,
      "remainingDays": 8,
      "carryOverDays": 0,
      "grantedDays": 20,
      "expiredDays": 0,
      "remarks": "ベテラン社員"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

### 2. Get Annual Leave by ID
**GET** `/api/v1/annual-leaves/{id}`

#### Path Parameters
- `id`: Annual leave ID

#### Response
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "田中太郎",
    "leaveYear": 2024,
    "totalDays": 20,
    "usedDays": 5,
    "remainingDays": 15,
    "carryOverDays": 2,
    "grantedDays": 18,
    "expiredDays": 0,
    "remarks": "新入社員"
  }
}
```

### 3. Get Annual Leave by Employee
**GET** `/api/v1/annual-leaves/employee/{employeeCode}`

#### Path Parameters
- `employeeCode`: Employee code

#### Query Parameters
- `year` (optional): Leave year (default: current year)

#### Response
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "田中太郎",
    "leaveYear": 2024,
    "totalDays": 20,
    "usedDays": 5,
    "remainingDays": 15,
    "carryOverDays": 2,
    "grantedDays": 18,
    "expiredDays": 0,
    "remarks": "新入社員",
    "leaveHistory": [
      {
        "date": "2024-03-15",
        "days": 1,
        "type": "年次有給休暇",
        "status": "承認済み"
      },
      {
        "date": "2024-04-20",
        "days": 2,
        "type": "年次有給休暇",
        "status": "承認済み"
      }
    ]
  }
}
```

### 4. Create Annual Leave
**POST** `/api/v1/annual-leaves`

#### Request Body
```json
{
  "employeeCode": "EMP003",
  "leaveYear": 2024,
  "totalDays": 20,
  "usedDays": 0,
  "remainingDays": 20,
  "carryOverDays": 0,
  "grantedDays": 20,
  "expiredDays": 0,
  "remarks": "新入社員の年休設定"
}
```

#### Response
```json
{
  "success": true,
  "message": "Annual leave created successfully",
  "data": {
    "id": 3,
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 5. Update Annual Leave
**PUT** `/api/v1/annual-leaves/{id}`

#### Path Parameters
- `id`: Annual leave ID

#### Request Body
```json
{
  "totalDays": 22,
  "usedDays": 3,
  "remainingDays": 19,
  "carryOverDays": 2,
  "grantedDays": 20,
  "expiredDays": 0,
  "remarks": "年休日数更新"
}
```

#### Response
```json
{
  "success": true,
  "message": "Annual leave updated successfully",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-15T11:00:00Z"
  }
}
```

### 6. Delete Annual Leave
**DELETE** `/api/v1/annual-leaves/{id}`

#### Path Parameters
- `id`: Annual leave ID

#### Response
```json
{
  "success": true,
  "message": "Annual leave deleted successfully"
}
```

### 7. Request Leave
**POST** `/api/v1/annual-leaves/request`

#### Request Body
```json
{
  "employeeCode": "EMP001",
  "leaveType": "年次有給休暇",
  "startDate": "2024-05-15",
  "endDate": "2024-05-17",
  "days": 3,
  "reason": "家族旅行"
}
```

#### Response
```json
{
  "success": true,
  "message": "Leave request submitted successfully",
  "data": {
    "requestId": "REQ2024001",
    "status": "申請中",
    "createdAt": "2024-01-15T10:30:00Z"
  }
}
```

### 8. Approve/Reject Leave Request
**PUT** `/api/v1/annual-leaves/request/{requestId}/status`

#### Path Parameters
- `requestId`: Leave request ID

#### Request Body
```json
{
  "status": "承認済み",
  "approverCode": "MGR001",
  "comments": "承認します"
}
```

#### Response
```json
{
  "success": true,
  "message": "Leave request status updated successfully",
  "data": {
    "requestId": "REQ2024001",
    "status": "承認済み",
    "approvedAt": "2024-01-15T11:00:00Z"
  }
}
```

### 9. Get Leave Requests
**GET** `/api/v1/annual-leaves/requests`

#### Query Parameters
- `page` (optional): Page number (default: 1)
- `size` (optional): Page size (default: 20)
- `employeeCode` (optional): Filter by employee
- `status` (optional): Filter by status
- `startDate` (optional): Filter by start date
- `endDate` (optional): Filter by end date

#### Response
```json
{
  "data": [
    {
      "requestId": "REQ2024001",
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "leaveType": "年次有給休暇",
      "startDate": "2024-05-15",
      "endDate": "2024-05-17",
      "days": 3,
      "reason": "家族旅行",
      "status": "承認済み",
      "approverCode": "MGR001",
      "approvedAt": "2024-01-15T11:00:00Z",
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 50,
    "totalPages": 3
  }
}
```

### 10. Get Leave Statistics
**GET** `/api/v1/annual-leaves/statistics`

#### Query Parameters
- `year` (optional): Leave year (default: current year)
- `departmentId` (optional): Filter by department
- `divisionId` (optional): Filter by division

#### Response
```json
{
  "data": {
    "year": 2024,
    "totalEmployees": 100,
    "totalLeaveDays": 2000,
    "usedLeaveDays": 1200,
    "remainingLeaveDays": 800,
    "averageUsageRate": 60.0,
    "leaveByMonth": [
      {
        "month": "1月",
        "usedDays": 150,
        "percentage": 12.5
      },
      {
        "month": "2月",
        "usedDays": 120,
        "percentage": 10.0
      }
    ],
    "leaveByDepartment": [
      {
        "departmentName": "営業部",
        "totalDays": 400,
        "usedDays": 250,
        "usageRate": 62.5
      },
      {
        "departmentName": "開発部",
        "totalDays": 300,
        "usedDays": 180,
        "usageRate": 60.0
      }
    ]
  }
}
```

### 11. Search Annual Leaves
**GET** `/api/v1/annual-leaves/search`

#### Query Parameters
- `keyword` (required): Search keyword
- `year` (optional): Filter by year
- `departmentId` (optional): Filter by department

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "departmentName": "営業部",
      "leaveYear": 2024,
      "totalDays": 20,
      "usedDays": 5,
      "remainingDays": 15
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 25,
    "totalPages": 2
  }
}
```

### 12. Bulk Update Annual Leaves
**PUT** `/api/v1/annual-leaves/bulk-update`

#### Request Body
```json
{
  "updates": [
    {
      "id": 1,
      "totalDays": 22,
      "usedDays": 3,
      "remainingDays": 19
    },
    {
      "id": 2,
      "totalDays": 20,
      "usedDays": 8,
      "remainingDays": 12
    }
  ]
}
```

#### Response
```json
{
  "success": true,
  "message": "Annual leaves updated successfully",
  "data": {
    "updatedCount": 2,
    "failedCount": 0,
    "errors": []
  }
}
```

### 13. Get Leave Calendar
**GET** `/api/v1/annual-leaves/calendar`

#### Query Parameters
- `year` (optional): Year (default: current year)
- `month` (optional): Month (default: current month)
- `departmentId` (optional): Filter by department

#### Response
```json
{
  "data": {
    "year": 2024,
    "month": 5,
    "calendar": [
      {
        "date": "2024-05-01",
        "isHoliday": true,
        "leaveRequests": [
          {
            "employeeCode": "EMP001",
            "employeeName": "田中太郎",
            "leaveType": "年次有給休暇",
            "status": "承認済み"
          }
        ]
      },
      {
        "date": "2024-05-02",
        "isHoliday": false,
        "leaveRequests": []
      }
    ]
  }
}
```

### 14. Export Leave Data
**GET** `/api/v1/annual-leaves/export`

#### Query Parameters
- `format` (optional): Export format (csv, excel) (default: excel)
- `year` (optional): Leave year
- `departmentId` (optional): Filter by department

#### Response
File download with leave data in specified format

## Error Responses

### 400 Bad Request
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "Invalid input data",
  "details": [
    {
      "field": "totalDays",
      "message": "Total days must be a positive number"
    }
  ]
}
```

### 404 Not Found
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "Annual leave record not found"
}
```

### 409 Conflict
```json
{
  "success": false,
  "error": "CONFLICT",
  "message": "Leave request conflicts with existing leave"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "INTERNAL_ERROR",
  "message": "An unexpected error occurred"
}
```

## Business Rules

1. **Leave Calculation**: Remaining days = Total days - Used days
2. **Carry Over**: Maximum 5 days can be carried over to next year
3. **Leave Request**: Must be submitted at least 1 day in advance
4. **Approval**: Only managers can approve leave requests
5. **Expiration**: Unused leave days expire at year end (except carry over)
6. **Consecutive Days**: Maximum 5 consecutive days without special approval

## Database Constraints

- Primary Key: `ID`
- Foreign Key: `社員コード` → `T_社員マスタ.社員コード`
- Check constraints for positive values
- Unique constraint on employee code and year combination

## Usage Examples

### Get annual leave for specific employee
```bash
curl -X GET "https://api.company.com/api/v1/annual-leaves/employee/EMP001?year=2024" \
  -H "Authorization: Bearer your-token"
```

### Request leave
```bash
curl -X POST "https://api.company.com/api/v1/annual-leaves/request" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeCode": "EMP001",
    "leaveType": "年次有給休暇",
    "startDate": "2024-05-15",
    "endDate": "2024-05-17",
    "days": 3,
    "reason": "家族旅行"
  }'
```

### Get leave statistics
```bash
curl -X GET "https://api.company.com/api/v1/annual-leaves/statistics?year=2024" \
  -H "Authorization: Bearer your-token"
```

---

*This API documentation is part of the Employee Management System*
