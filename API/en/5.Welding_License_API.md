# 5. Welding License API

## Overview
API for managing welding license data (T_溶接免許). Provides comprehensive welding license management functionality including license registration, validation, and tracking.

## Base URL
`/api/v1/welding-licenses`

## Authentication
Bearer Token required for all endpoints

## Data Models

### Welding License Entity
```json
{
  "id": "number",                     // ID (Primary Key)
  "employeeCode": "string",           // 社員コード (Foreign Key)
  "licenseNumber": "string",          // 免許番号
  "licenseType": "string",            // 免許種別
  "issueDate": "date",                // 交付日
  "expiryDate": "date",               // 有効期限
  "issuingAuthority": "string",       // 交付機関
  "status": "string",                 // ステータス
  "remarks": "string"                 // 備考
}
```

### License Renewal Entity
```json
{
  "renewalId": "string",              // 更新ID
  "licenseId": "number",              // 免許ID
  "renewalDate": "date",              // 更新日
  "newExpiryDate": "date",            // 新有効期限
  "renewalReason": "string",          // 更新理由
  "status": "string",                 // ステータス
  "processedBy": "string",            // 処理者
  "processedAt": "datetime",          // 処理日時
  "createdAt": "datetime"             // 作成日時
}
```

## Endpoints

### 1. Get All Welding Licenses
**GET** `/api/v1/welding-licenses`

#### Query Parameters
- `page` (optional): Page number (default: 1)
- `size` (optional): Page size (default: 20)
- `employeeCode` (optional): Filter by employee code
- `licenseType` (optional): Filter by license type
- `status` (optional): Filter by status
- `expiringSoon` (optional): Filter by licenses expiring within days

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "日本溶接協会",
      "status": "有効",
      "remarks": "新規取得"
    },
    {
      "id": 2,
      "employeeCode": "EMP002",
      "employeeName": "佐藤花子",
      "licenseNumber": "WL2024002",
      "licenseType": "特殊溶接",
      "issueDate": "2023-06-20",
      "expiryDate": "2025-06-20",
      "issuingAuthority": "日本溶接協会",
      "status": "有効",
      "remarks": "更新済み"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 50,
    "totalPages": 3
  }
}
```

### 2. Get Welding License by ID
**GET** `/api/v1/welding-licenses/{id}`

#### Path Parameters
- `id`: Welding license ID

#### Response
```json
{
  "data": {
    "id": 1,
    "employeeCode": "EMP001",
    "employeeName": "田中太郎",
    "licenseNumber": "WL2024001",
    "licenseType": "一般溶接",
    "issueDate": "2024-01-15",
    "expiryDate": "2026-01-15",
    "issuingAuthority": "日本溶接協会",
    "status": "有効",
    "remarks": "新規取得",
    "renewalHistory": [
      {
        "renewalId": "REN2024001",
        "renewalDate": "2024-01-15",
        "newExpiryDate": "2026-01-15",
        "renewalReason": "新規取得",
        "status": "完了"
      }
    ]
  }
}
```

### 3. Get Welding Licenses by Employee
**GET** `/api/v1/welding-licenses/employee/{employeeCode}`

#### Path Parameters
- `employeeCode`: Employee code

#### Query Parameters
- `status` (optional): Filter by status
- `activeOnly` (optional): Show only active licenses (default: false)

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "日本溶接協会",
      "status": "有効",
      "remarks": "新規取得"
    }
  ]
}
```

### 4. Create Welding License
**POST** `/api/v1/welding-licenses`

#### Request Body
```json
{
  "employeeCode": "EMP003",
  "licenseNumber": "WL2024003",
  "licenseType": "一般溶接",
  "issueDate": "2024-01-20",
  "expiryDate": "2026-01-20",
  "issuingAuthority": "日本溶接協会",
  "status": "有効",
  "remarks": "新規免許取得"
}
```

#### Response
```json
{
  "success": true,
  "message": "Welding license created successfully",
  "data": {
    "id": 3,
    "createdAt": "2024-01-20T10:30:00Z"
  }
}
```

### 5. Update Welding License
**PUT** `/api/v1/welding-licenses/{id}`

#### Path Parameters
- `id`: Welding license ID

#### Request Body
```json
{
  "licenseType": "特殊溶接",
  "expiryDate": "2027-01-15",
  "status": "有効",
  "remarks": "免許種別変更"
}
```

#### Response
```json
{
  "success": true,
  "message": "Welding license updated successfully",
  "data": {
    "id": 1,
    "updatedAt": "2024-01-20T11:00:00Z"
  }
}
```

### 6. Delete Welding License
**DELETE** `/api/v1/welding-licenses/{id}`

#### Path Parameters
- `id`: Welding license ID

#### Response
```json
{
  "success": true,
  "message": "Welding license deleted successfully"
}
```

### 7. Renew Welding License
**POST** `/api/v1/welding-licenses/{id}/renew`

#### Path Parameters
- `id`: Welding license ID

#### Request Body
```json
{
  "renewalDate": "2024-01-20",
  "newExpiryDate": "2026-01-20",
  "renewalReason": "定期更新",
  "processedBy": "ADMIN001"
}
```

#### Response
```json
{
  "success": true,
  "message": "Welding license renewed successfully",
  "data": {
    "renewalId": "REN2024002",
    "renewalDate": "2024-01-20T10:30:00Z"
  }
}
```

### 8. Get License Renewals
**GET** `/api/v1/welding-licenses/{id}/renewals`

#### Path Parameters
- `id`: Welding license ID

#### Response
```json
{
  "data": [
    {
      "renewalId": "REN2024001",
      "licenseId": 1,
      "renewalDate": "2024-01-15",
      "newExpiryDate": "2026-01-15",
      "renewalReason": "新規取得",
      "status": "完了",
      "processedBy": "ADMIN001",
      "processedAt": "2024-01-15T10:30:00Z",
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ]
}
```

### 9. Get Expiring Licenses
**GET** `/api/v1/welding-licenses/expiring`

#### Query Parameters
- `days` (optional): Days ahead to check (default: 30)
- `departmentId` (optional): Filter by department

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "expiryDate": "2024-02-15",
      "daysUntilExpiry": 15,
      "status": "有効"
    }
  ],
  "summary": {
    "totalExpiring": 5,
    "criticalExpiring": 2,
    "warningExpiring": 3
  }
}
```

### 10. Get License Statistics
**GET** `/api/v1/welding-licenses/statistics`

#### Query Parameters
- `year` (optional): Year (default: current year)
- `departmentId` (optional): Filter by department

#### Response
```json
{
  "data": {
    "year": 2024,
    "totalLicenses": 100,
    "activeLicenses": 85,
    "expiredLicenses": 10,
    "expiringSoon": 5,
    "licensesByType": [
      {
        "type": "一般溶接",
        "count": 60,
        "percentage": 60.0
      },
      {
        "type": "特殊溶接",
        "count": 40,
        "percentage": 40.0
      }
    ],
    "licensesByStatus": [
      {
        "status": "有効",
        "count": 85,
        "percentage": 85.0
      },
      {
        "status": "期限切れ",
        "count": 10,
        "percentage": 10.0
      },
      {
        "status": "更新中",
        "count": 5,
        "percentage": 5.0
      }
    ],
    "renewalRate": 95.0
  }
}
```

### 11. Search Welding Licenses
**GET** `/api/v1/welding-licenses/search`

#### Query Parameters
- `keyword` (required): Search keyword
- `licenseType` (optional): Filter by license type
- `status` (optional): Filter by status

#### Response
```json
{
  "data": [
    {
      "id": 1,
      "employeeCode": "EMP001",
      "employeeName": "田中太郎",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "expiryDate": "2026-01-15",
      "status": "有効"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 25,
    "totalPages": 2
  }
}
```

### 12. Validate License
**POST** `/api/v1/welding-licenses/validate`

#### Request Body
```json
{
  "licenseNumber": "WL2024001",
  "employeeCode": "EMP001"
}
```

#### Response
```json
{
  "valid": true,
  "license": {
    "id": 1,
    "licenseNumber": "WL2024001",
    "licenseType": "一般溶接",
    "expiryDate": "2026-01-15",
    "status": "有効"
  },
  "message": "License is valid"
}
```

### 13. Bulk Import Licenses
**POST** `/api/v1/welding-licenses/import`

#### Request Body
```json
{
  "licenses": [
    {
      "employeeCode": "EMP001",
      "licenseNumber": "WL2024001",
      "licenseType": "一般溶接",
      "issueDate": "2024-01-15",
      "expiryDate": "2026-01-15",
      "issuingAuthority": "日本溶接協会",
      "status": "有効"
    },
    {
      "employeeCode": "EMP002",
      "licenseNumber": "WL2024002",
      "licenseType": "特殊溶接",
      "issueDate": "2024-01-20",
      "expiryDate": "2026-01-20",
      "issuingAuthority": "日本溶接協会",
      "status": "有効"
    }
  ]
}
```

#### Response
```json
{
  "success": true,
  "message": "Licenses imported successfully",
  "data": {
    "importedCount": 2,
    "failedCount": 0,
    "errors": []
  }
}
```

### 14. Export License Data
**GET** `/api/v1/welding-licenses/export`

#### Query Parameters
- `format` (optional): Export format (csv, excel) (default: excel)
- `status` (optional): Filter by status
- `departmentId` (optional): Filter by department

#### Response
File download with license data in specified format

## Error Responses

### 400 Bad Request
```json
{
  "success": false,
  "error": "VALIDATION_ERROR",
  "message": "Invalid input data",
  "details": [
    {
      "field": "licenseNumber",
      "message": "License number is required"
    }
  ]
}
```

### 404 Not Found
```json
{
  "success": false,
  "error": "NOT_FOUND",
  "message": "Welding license not found"
}
```

### 409 Conflict
```json
{
  "success": false,
  "error": "CONFLICT",
  "message": "License number already exists"
}
```

### 500 Internal Server Error
```json
{
  "success": false,
  "error": "INTERNAL_ERROR",
  "message": "An unexpected error occurred"
}
```

## Business Rules

1. **License Number**: Must be unique across all licenses
2. **Expiry Date**: Must be after issue date
3. **Renewal**: Can only renew active licenses
4. **Status**: Valid statuses are: 有効, 期限切れ, 更新中, 無効
5. **Employee**: Employee code must reference existing employee
6. **Authority**: Issuing authority must be valid

## Database Constraints

- Primary Key: `ID`
- Foreign Key: `社員コード` → `T_社員マスタ.社員コード`
- Unique constraint on license number
- Check constraints for date validation

## Usage Examples

### Get welding licenses for specific employee
```bash
curl -X GET "https://api.company.com/api/v1/welding-licenses/employee/EMP001" \
  -H "Authorization: Bearer your-token"
```

### Create new welding license
```bash
curl -X POST "https://api.company.com/api/v1/welding-licenses" \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "employeeCode": "EMP003",
    "licenseNumber": "WL2024003",
    "licenseType": "一般溶接",
    "issueDate": "2024-01-20",
    "expiryDate": "2026-01-20",
    "issuingAuthority": "日本溶接協会",
    "status": "有効"
  }'
```

### Get expiring licenses
```bash
curl -X GET "https://api.company.com/api/v1/welding-licenses/expiring?days=30" \
  -H "Authorization: Bearer your-token"
```

---

*This API documentation is part of the Employee Management System*
